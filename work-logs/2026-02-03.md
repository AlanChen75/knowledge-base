# 工作日誌 2026-02-03

## [18:00] Diagram Render Service v3 — Pillow 渲染引擎重寫
- **來源**: Happy Coder / CLI
- **狀態**: ✅ 完成
- **目標**: 用 Pillow 直接渲染精美圖表取代 ComfyUI，解決座標映射和渲染速度問題

### 背景
- v2 使用三階段流程：骨架圖 → ComfyUI ControlNet 渲染 → 文字疊加
- 問題：ComfyUI 渲染 12s、座標映射不精確（文字位置偏移）、需佔用 GPU
- 決定用 Pillow 直接繪製精美圖表，一步到位

### 完成步驟
1. [18:00] 建立 `pillow_renderer.py`（~1100 行）
   - 4 種視覺風格主題：isometric（等距立體）、flat（扁平設計）、blueprint（藍圖）、tech（科技霓虹）
   - 每種風格有完整配色：節點填充、邊框、陰影、文字、背景裝飾
   - 支援 4 種圖表類型：architecture、flowchart、product、cover
   - 自適應模組高度（根據子模組數量）
   - 拓樸排序佈局（含環路處理）
   - 智慧連線端點（根據相對位置）
   - 圓角矩形陰影、文字自動換行/截斷

2. [18:03] 建立新版 `api.py`（v3）
   - 移除 ComfyUI 依賴（不再需要 comfyui_client.py、text_overlay.py、骨架生成器）
   - 同步渲染（不再需要 BackgroundTasks）
   - 渲染時間從 12s 降至 50-335ms

3. [18:05] 部署到 ac-3090 並測試
   - product/isometric：335ms ✅（5 模組 + 13 子模組 + 4 連線）
   - product/flat：51ms ✅
   - product/blueprint：62ms ✅
   - product/tech：246ms ✅
   - architecture/isometric：73ms ✅（6 節點 + 5 連線 + 2 分組）
   - flowchart/flat：55ms ✅（含環路的 6 節點流程）
   - cover/tech：56ms ✅

4. [18:10] 修復佈局問題
   - 自適應模組高度（根據子模組數計算行高）
   - 增加模組間距（25→40px）給箭頭標籤更多空間
   - 邊標籤偏移機制（避免多條連線標籤重疊）
   - 拓樸排序環路處理（選最小 in-degree 打破環）

5. [18:18] 防火牆設定
   - 在 ac-3090 ts-input chain 加入 100.116.154.40 ACCEPT 規則
   - 但 Tailscale 直連仍有問題（SSH 通但 HTTP 不通）
   - 暫時用 SSH tunnel 解決：`ssh -L 18189:localhost:8189 ac-3090`

6. [18:20] 恢復 vLLM 服務
   - 停止 ComfyUI（釋放 7GB GPU）
   - 啟動 vLLM（Qwen2.5-7B-Instruct，佔 15GB）
   - 驗證 /v1/models 正常

### 效能對比
| 項目 | v2 (ComfyUI) | v3 (Pillow) |
|------|-------------|-------------|
| 渲染時間 | 10-14s | 50-335ms |
| GPU 需求 | 需要 SDXL + ControlNet | 不需要 GPU |
| 文字控制 | 後處理疊加（座標偏移） | 直接繪製（精確對齊） |
| 依賴 | ComfyUI + SDXL + ControlNet LoRA | 純 Pillow |
| 與 vLLM 共存 | 不可能（GPU 不夠） | 完全相容 |

### 已知待改進
- 產品模組圖邊標籤仍有重疊情形（多條連線指向同一模組時）
- 架構圖分組框可能重疊（當不同分組的節點在同一列時）
- Tailscale 直連 8189 埠不通（需用 SSH tunnel）

### 變更檔案
- `ac-3090:~/diagram-service/pillow_renderer.py` — 新建（Pillow 渲染引擎）
- `ac-3090:~/diagram-service/api.py` — 重寫（v3，移除 ComfyUI 依賴）

### 服務狀態
- `diagram-service.service` on ac-3090:8189 — ✅ 運行中（v3 Pillow 引擎）
- `vllm.service` on ac-3090:8000 — ✅ 運行中（Qwen2.5-7B-Instruct）
- ComfyUI — 已停止（不再需要）

## [18:30-18:55] Diagram Service v3 — Product 渲染優化（續）

- **來源**: CLI / Happy Coder（延續上個 session）
- **狀態**: ✅ 完成

### 完成項目

1. **發現 API 用 `pillow_renderer.py` 而非 `style_renderer.py`**
   - 兩套渲染器同時存在，API 引用的是 `pillow_renderer.py`（1134 行）
   - `style_renderer.py` 的修改完全沒被使用

2. **修正 Product 渲染 — 連線避障**
   - 新增 `_route_around_obstacles()` 方法（Liang-Barsky 線段裁剪演算法）
   - 新增 `_draw_polyline_arrow()` 方法（折線 + 箭頭繪製）
   - 連線根據障礙物自動繞道上方或下方
   - 每條繞道線偏移 20px 避免重合

3. **標題和子模組文字自動縮小**
   - 標題：從 18px 遞減到 12px，找到能放入的最大字體
   - 子模組：從 13px 遞減到 10px
   - 仍放不下時截斷加 "..."

4. **連線標籤避免重疊**
   - 使用 `placed_labels` 追蹤已放置位置
   - 自動嘗試垂直偏移找到不重疊的位置

5. **全類型 × 全風格測試通過**

### 測試結果
| 類型 | 風格 | 速度 |
|------|------|------|
| architecture | isometric | 61ms |
| flowchart | flat | 51ms |
| product | isometric | 126ms |
| cover | tech | 49ms |
| product | flat | 71ms |
| product | blueprint | 76ms |
| product | tech | 85ms |

### 變更檔案
- `ac-3090:~/diagram-service/pillow_renderer.py` — 主要修改
- Git commit: ac22d4a

### 已知待改善
- 底部空白在單行模組時仍明顯
- deepresearch→illuminate 的繞道路線方向可再優化
