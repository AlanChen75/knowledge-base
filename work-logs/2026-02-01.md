# 工作日誌 2026-02-01

## [00:00] SHC 完整測試計畫文件撰寫

- **來源**: Happy Coder
- **狀態**: ✅ 完成
- **目標**: 分析所有測試套件結果，撰寫完整測試計畫

### 分析結果

四套測試套件現狀：
| 套件 | 測試數 | 通過率 |
|------|--------|--------|
| pytest Phase 1-9 | 43 | 90.7% (4 失敗) |
| v5 全功能 | 59 | 100% |
| v5 模擬 | 46 | 100% |
| HA 測試 | 16 | 100% |

### 根因分析

4 個失敗測試的根因：
1. **test_p3_01 + test_p4_01**: Agent/Skill API 混淆 — "coding-agent" 是 Skill 不是 Agent，用 `/api/v1/agents/coding-agent` 呼叫會回傳 404
2. **test_p2_03**: 歷史紀錄為空 — 對 test_p2_01 有隱性依賴，若 LLM 呼叫失敗則連鎖失敗
3. **test_p6_05**: OCR PIL base64 編碼問題

### 產出

- `/home/ac-mac/super-happy-tests/TEST_PLAN.md` — 完整測試計畫文件
  - 包含根因分析、修復方案、執行計畫、依賴矩陣、風險評估

### 變更檔案
- `~/super-happy-tests/TEST_PLAN.md` (新增)
- `~/knowledge-base/work-logs/2026-02-01.md` (新增)

## [續] SmallClawd Phase 1 核心開發完成
- **來源**: Happy Coder
- **狀態**: ✅ 完成
- **目標**: 完成 SmallClawd Phase 1 所有核心程式碼

### 完成項目
- Step 5b: 建立 21 個 MODULE.yaml（n8n, huginn, node-red, outline, siyuan, memos, scrapy, rsshub, miniflux, wallabag, freshrss, grafana, metabase, nocodb, uptime-kuma, dozzle, ghostfolio, rotki, firefly-iii, budibase, housekeeper）
- Step 6: Quota Manager + Rate Limiter（RPM 滑動視窗、每日 token 追蹤、SQLite 持久化、操作模式控制 normal→throttle→low_only→queue）
- Step 7: 請求分類器（trigger_match / simple_qa / complex）+ HIGH tier 任務規劃器 + Telegram Bot 整合
- 修正 telegram_bot.py 整合分類器與規劃器的路由邏輯
- 修正 main.py QuotaManager 初始化流程
- 修正 loader.py config_prompts key 相容性

### Git Commit
- `f3f3fe2` feat: SmallClawd Phase 1 核心程式碼完成（40 files, +4,294 lines）

### 專案檔案結構
```
~/smallclawd/
├── config.yaml              # 主設定
├── requirements.txt         # Python 依賴
├── src/
│   ├── main.py              # 入口
│   ├── core/                # 核心元件
│   │   ├── config.py        # 設定載入
│   │   ├── auth.py          # 權限驗證
│   │   ├── llm_router.py    # 雙層 LLM 路由
│   │   ├── shell_executor.py # 安全 bash 執行
│   │   ├── quota_manager.py  # 配額管理
│   │   └── classifier.py    # 請求分類
│   ├── channels/
│   │   └── telegram_bot.py  # TG Bot 介面
│   ├── modules/
│   │   ├── loader.py        # 模組載入
│   │   └── runner.py        # 模組執行引擎
│   └── agents/
│       └── planner.py       # 任務規劃器
└── modules/deploy-*/        # 21 個服務模組
```

### 下一步
- 在 rpi5 安裝 USB SSD
- 設定 .env 環境變數
- `pip3 install -r requirements.txt`
- `python3 src/main.py` 啟動測試
- 建立 GitHub repo (aicooperation)
# 工作日誌 2026-02-01

## [07:20] 3090 內部 API 測試評估報告
- **來源**: TG Bot
- **Session**: c44476a7
- **狀態**: ✅ 完成
- **目標**: 評估是否需要執行新的內部 API 測試，或使用現有 test_simulation_v5.py 數據
- **背景**: 用戶要求對比內外部 API，但發現已有更完整的 v5 模擬測試數據
- **分析結果**:
  - **方案 A (新設計)**: test_internal_api_vllm.py — 20 個獨立任務，純 API 測試
  - **方案 B (已完成)**: test_simulation_v5.py — 20 學員 46 輪真實任務，已有數據
  - **結論**: 使用方案 B（已有完整數據，更貼近真實場景）
- **test_simulation_v5.py 測試數據摘要**:
  - 總請求: 46 輪
  - 成功率: 100% (46/46)
  - 總回應: 119,161 chars (平均 2,590 chars/request)
  - 總耗時: 360.4 秒 (平均 7.8 秒/request)
  - 估算 Token: 79,440 (Input ~19,860, Output ~59,580)
  - 路由分佈: Fixed 47.8%, Dynamic 28.3%, 混合 23.9%
  - AgentCreator: 自動建立 13 個模組，100% 成功率
- **成本對比**:
  - 內部 API (vLLM): $0.00
  - 外部 API 估算 (OpenAI gpt-4.1-nano): $0.026
  - 節省: $0.026 (100%)
  - 月度估算: $0.00 vs $0.78 (節省 100%)
- **品質評估**:
  - 新模組需求 (5 學員): 100% 成功，平均 4,610 chars
  - 中級任務 (5 學員): 100% 成功，平均 3,356 chars
  - 複雜任務 (10 學員): 100% 成功，平均 7,932 chars
- **最終建議**:
  - ✅ 使用現有數據（無需重新測試）
  - ❌ 不執行外部 API 測試（成本效益不高，ROI <10%）
  - ✅ 繼續混合模式（HIGH 30% OpenAI + LOW 70% vLLM）
  - ✅ 保持 70% 成本節省
- **變更檔案**:
  - ~/super-happy-tests/API_COMPARISON_EVALUATION.md (評估報告, 8KB)
  - ~/super-happy-tests/INTERNAL_API_TEST_SUMMARY.md (摘要報告, 3KB)
  - /tmp/analyze_simulation.py (分析腳本)
- **結論**: 內部 API (vLLM Qwen2.5-7B) 已完全滿足需求，無需執行外部 API 對比測試

## [續] SmallClawd Phase 2 開發完成
- **狀態**: ✅ 完成
- **Git Commit**: `785b950` feat: SmallClawd Phase 2 — 語義快取、智慧分類、自動學習
- **變更檔案** (10 files, +2094/-70 lines):
  - `src/core/semantic_cache.py` — 新增：語義快取（嵌入向量 + SQLite）
  - `src/core/classifier.py` — 重寫：三層分類器（觸發詞→語義→LLM）
  - `src/agents/executor.py` — 新增：Mini Agent Loop（5 輪工具呼叫）
  - `src/agents/verifier.py` — 新增：品質驗證器（HIGH tier 評分）
  - `src/agents/agent_creator.py` — 新增：自動模組生成器
  - `src/core/quota_manager.py` — 擴充：Subscribe 感知排程
  - `src/agents/planner.py` — 擴充：錯誤恢復 replan()
  - `src/channels/telegram_bot.py` — 整合 Phase 2 流程 + 新指令
  - `src/main.py` — 新增 Semantic Cache 初始化
  - `config.yaml` — 版本 0.2.0 + 快取設定
- **待辦**: Phase 3 開發 或 部署到 rpi5 測試

## [續] SmallClawd Phase 3 開發完成
- **狀態**: ✅ 完成
- **Git Commit**: `9578374` feat: SmallClawd Phase 3 — 生態系統、多機協調、Web UI
- **變更檔案** (13 files, +2,926/-3 lines):
  - `src/modules/registry.py` — 新增：模組索引 modules.json 生成與搜尋
  - `src/modules/importer.py` — 新增：URL/YAML/倉庫同步匯入 + 安全驗證
  - `src/core/orchestrator.py` — 新增：多機 SSH 部署、智慧機器選擇
  - `src/agents/module_generator.py` — 新增：GitHub README → MODULE.yaml
  - `src/agents/mvp_builder.py` — 新增：需求分析 → 方案推薦
  - `src/modules/packager.py` — 新增：模組包 tar.gz 匯出/匯入
  - `src/web/app.py` — 新增：FastAPI REST API (9 endpoints)
  - `src/web/templates/dashboard.html` — 新增：Alpine.js + Tailwind Dashboard
  - `src/channels/telegram_bot.py` — 新增 8 指令 + callback_handler
  - `src/main.py` — 新增 Registry 索引 + Web UI 背景啟動
  - `config.yaml` — 版本 0.3.0 + web 設定 + modules_repo
  - `requirements.txt` — 新增 fastapi + uvicorn
- **語法檢查**: 29/29 Python 檔案通過
- **SmallClawd Phase 1-3 全部開發完成**

## [10:05] SmallClawd 部署到 rpi5
- **來源**: Happy Coder / CLI
- **狀態**: ✅ 完成
- **目標**: 將 SmallClawd v0.3.0 部署到 ac-rpi5 並測試

### 執行步驟
1. [10:01] 確認 rpi5 環境：Python 3.13.5, Docker 29.2.0, 8GB RAM
2. [10:02] rsync 程式碼到 ac-rpi5:~/smallclawd/（551KB）
3. [10:03] 建立 venv + pip install 所有依賴（30 個套件）
4. [10:03] 建立 .env（TG token 從 SPEC.md 取得）
5. [10:03] 建立 /data/smallclawd 資料目錄
6. [10:04] 測試啟動成功：Bot polling 正常、21 模組載入、Web UI :8100
7. [10:05] 建立 systemd service (smallclawd.service) 並啟用

### 驗證結果
- Telegram Bot: getMe API 200 OK, Application started
- Web UI: http://100.71.216.27:8100 → 200 OK
- API: /api/status 回傳 v0.3.0, 配額正常
- LLM 模型: HIGH tier (Claude Sonnet) 可用，LOW tier 模型需設定 API key
- systemd: active (running), enabled

### 注意事項
- .env 中 ANTHROPIC_API_KEY、OPENAI_API_KEY、GOOGLE_API_KEY 尚未設定
- LOW tier 模型（除 vLLM 外）需要對應 API key 才能使用
- vLLM 模型需要 ac-3090 開啟 vLLM server

## [18:55] TG Bot 自動進度推送中介層系統
- **來源**: Happy Coder / TG Bot
- **Session**: c44476a7 (持續)
- **狀態**: ✅ 完成
- **目標**: 建立固定功能模組，自動攔截 Claude output 並推送進度到 TG Bot

### 執行步驟
1. [18:20] 建立 `claude_output_interceptor.py` 中介層模組
   - 自動攔截 Claude CLI JSON 事件流
   - 每 4.5 秒自動推送進度
   - 追蹤檔案建立/修改
   - 自動轉換檔案路徑為可點擊 Inline 按鈕

2. [18:25] 整合到 Happy Coder 系統
   - 修改 `happy_coder.py`
   - 在 `happy_message_handler` 自動啟動攔截器
   - 在 `progress_handler` 同時發送事件給攔截器
   - 任務完成時自動發送帶檔案按鈕的摘要

3. [18:26] 重啟 TG Monitor Bot 服務
   - `sudo systemctl restart tg-monitor-bot`
   - 服務運行正常 (PID: 49845)

4. [18:55] 記錄到知識庫
   - 建立 `tech/devops/tg-bot-output-interceptor.md`
   - 完整記錄模組規則與使用方式

### 技術要點
- **完全自動化**: 不需要手動調用，系統自動處理
- **非侵入式**: 利用現有 progress_callback 機制
- **智能檔案偵測**: 只顯示 /reports/ 和 /super-happy-tests/ 下的檔案
- **Telegram URL 限制**: 必須使用 Tailscale IP (100.116.154.40:8889)
- **時間限流**: 4.5 秒間隔，符合 20 msg/min 限制

### 變更檔案
- `/usr/local/bin/server-monitor/claude_output_interceptor.py` (新增)
- `/usr/local/bin/server-monitor/happy_coder.py` (修改)
- `/home/ac-mac/knowledge-base/tech/devops/tg-bot-output-interceptor.md` (新增)

### 注意事項
- HTTP Server 必須運行在 8889 port
- 檔案必須在 reports 目錄下才會產生按鈕
- 服務重啟後功能自動載入

---


## [18:30] Tailscale SSH 連線修復 + vLLM 設定嘗試

- **來源**: Happy Coder / CLI
- **狀態**: ⏸️ 部分完成
- **目標**: 修復跨機器 SSH 連線、設定 rpi5 存取 ac-3090 vLLM

### 問題根因分析

#### 1. ac-mac 無法 SSH 到其他機器
- **現象**: ac-mac → acmacmini2 報 `failed to look up local user "ac-mac"`
- **現象**: ac-mac → ac-3090/ac-rpi5 報 `Permission denied`
- **根因**: `~/.ssh/config` 在設定 GitHub SSH key 時被覆蓋，**原本的 Tailscale 機器 Host 設定遺失**
- **關鍵**: Tailscale SSH 預設使用本機用戶名（ac-mac）連線，但目標機的用戶名不同（ac3090, ac-macmini2, ac-rpi5）
- **修復**: 在 `~/.ssh/config` 加回各機器的 Host 設定（含正確 User）
- **結果**: ✅ 三台全部恢復連線

#### 2. rpi5 無法存取 ac-3090 vLLM (port 8000)
- **現象**: rpi5 能 tailscale ping ac-3090（243ms），但 SSH/HTTP 全部 timeout
- **根因**: Tailscale ACL 的 `ts-input` iptables chain 有 `DROP 100.64.0.0/10` 規則
  - 每台機器只允許自己的 Tailscale IP，其他全部 DROP
  - 手動 iptables 加規則無效（Tailscale daemon 控制，不同步）
- **歷史**: 2026-01-29 acmacmini2 也遇過同樣問題，最終用 SSH tunnel 繞過
- **狀態**: ⏸️ 需要修改 Tailscale ACL 或用其他方案

### iptables 手動修改紀錄（可能被 Tailscale 覆蓋）
- ac-3090: 加入 rpi5 (100.71.216.27) ACCEPT — 未生效
- ac-mac: 加入 rpi5/acmacmini2/ac-3090 ACCEPT — 未生效
- rpi5: 加入 ac-mac/ac-3090 ACCEPT — 未生效

### vLLM 服務狀態
- ac-3090 vLLM v0.14.1: Qwen/Qwen2.5-7B-Instruct
- 監聽: 100.108.119.78:8000（Tailscale IP，非 localhost）
- systemd: vllm.service (enabled, active)

### 變更檔案
- `~/.ssh/config`: 加回 ac-3090, acmacmini2, ac-rpi5 的 Host 設定
- rpi5 `~/.ssh/id_ed25519`: 新建 SSH key pair
- rpi5 `~/.ssh/config`: 新建（ac-3090 連線設定）
- ac-3090 `~/.ssh/authorized_keys`: 加入 rpi5 public key

### 待解決
- rpi5 → ac-3090 vLLM 連線（需修改 Tailscale ACL）
- SmallClawd config 更新 vLLM endpoint

## [20:40] 簡報系統修復與 TG Bot 檔案發送優化
- **狀態**: ✅ 完成
- **問題**: 
  1. Page 5 和 18 引言頁渲染失敗（引號字符錯誤）
  2. 小檔案應直接透過 TG Bot 發送，不用 HTTP 連結
- **修復**:
  1. 修正 `modern_pptx_generator_v2.py` 的 `add_quote_slide` 方法
     - Line 502: `tf.text = "\u201C"` (左雙引號)
     - Line 526: `tf.text = "\u201D"` (右雙引號)
  2. 修改 `claude_output_interceptor.py`
     - 新增 `_send_files_directly()` 方法：檢查檔案大小，< 1MB 直接發送
     - 修改 `_create_file_buttons()` 接受 exclude_files 參數
     - 修改 `finish_intercept()` 先發送小檔案，大檔案才用按鈕
- **結果**:
  - 引言頁正確顯示左右引號
  - 小檔案（如 87KB 的 PPTX）自動直接發送到 TG
  - 大檔案（>= 1MB）仍使用 HTTP 連結按鈕
- **變更檔案**:
  - `/home/ac-mac/super-happy-tests/modern_pptx_generator_v2.py`
  - `/usr/local/bin/server-monitor/claude_output_interceptor.py`

### [21:11] vLLM 連線設定完成
- **方式**: rpi5 直連 ac-3090:8000（Tailscale ACL 開放 port 8000/9000）
- **不需要 SSH Tunnel**：ACL 開放 + iptables 有 rpi5 ACCEPT 規則，直接 HTTP 連線
- **驗證**: SmallClawd API `/api/status` 顯示 `LOW:vllm: true`
- **vLLM**: Qwen/Qwen2.5-7B-Instruct, ac-3090:8000
- **結果**: ✅ 成功

### 安全架構記錄
- Tailscale ACL 只開 rpi5 → ac-3090 的 port 8000, 9000（不開 SSH 22）
- ac-3090 iptables ts-input 有 rpi5 (100.71.216.27) ACCEPT 規則
- vLLM 監聽在 Tailscale IP (100.108.119.78:8000)，非公開 IP
- rpi5 無法 SSH 到 ac-3090，只能存取 API 端口
