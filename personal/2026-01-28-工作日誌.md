---
title: 工作日誌 - Happy 服務設定與除錯
date: 2026-01-28
category: 工作日誌
tags: [happy, codex, rpi5, mac-mini, tailscale, 系統維護]
---

# 2026-01-28 工作日誌

## 主要任務：各機器 Happy 服務設定與除錯

### 1. RPI5 Happy 服務問題排查

**問題現象**：手機 App 可以正常對話，但權限確認時會卡住無回應

**根本原因**：
- RPI5 的 Linux 核心不支援 Landlock（Linux 安全沙盒功能）
- Codex 執行命令時嘗試使用 Landlock sandbox 失敗
- 錯誤訊息：`error running landlock: Sandbox(LandlockRestrict)`
- Happy 的權限處理流程有 bug，`call_id` 變成 `undefined` 導致卡住

**解決方案**：
修改 Happy 的 Codex 設定，強制使用 `danger-full-access` 模式跳過 Landlock

```bash
# 備份
cp ~/.nvm/versions/node/v20.20.0/lib/node_modules/happy-coder/dist/runCodex-DarzxcRd.mjs \
   ~/.nvm/versions/node/v20.20.0/lib/node_modules/happy-coder/dist/runCodex-DarzxcRd.mjs.bak

# 修改
sed -i 's/return "workspace-write";/return "danger-full-access"; \/\/ RPI5: Landlock not supported/g' \
    ~/.nvm/versions/node/v20.20.0/lib/node_modules/happy-coder/dist/runCodex-DarzxcRd.mjs

# 重啟
sudo systemctl restart happy-coder.service
```

**文件**：詳細修復指南已記錄在 RPI5 的 `~/HAPPY-CODEX-FIX.md`

**注意**：Happy 更新後需重新執行此修改

---

### 2. Mac Mini 2 Happy 服務設定

**問題**：
- happy-coder.service 未啟用（disabled + inactive）
- 缺少 Codex

**解決步驟**：
1. 啟用並啟動 happy-coder.service
2. 安裝 Codex：`sudo npm install -g @openai/codex`
3. 清除卡住的 auth login 進程

**結果**：Mac Mini 2 可正常從手機連線

---

### 3. 監控服務更新

更新 `/usr/local/bin/server-monitor/check-services.sh`：

| 機器 | 新增監控的服務 |
|------|----------------|
| RPI5 | happy-coder, happy-proxy |
| Mac Mini 2 | clawdbot |

已同步腳本到各機器並 commit。

---

### 4. 發現的問題

**RPI5 磁碟使用率 81%**：待後續清理

**Happy + Codex 整合 bug**：
- `exec_approval_request` 的 `call_id` 沒有正確傳遞到權限處理器
- 這是 Happy 的 bug，不只 RPI5 有問題

---

## 機器狀態總覽

| 機器 | Tailscale IP | Happy 模式 | 狀態 |
|------|--------------|------------|------|
| Mac Mini | 100.116.154.40 | Claude | ✅ 正常 |
| Mac Mini 2 | 100.118.162.26 | Codex | ✅ 正常 |
| RPI5 | 100.71.216.27 | Codex | ⏳ 待測試（無額度） |
| 3090 | 100.108.119.78 | - | - |

---

## 學到的知識

1. **Happy 連線機制**：透過 WebSocket 連到 Happy 雲端，不是直接連本地 port
2. **Landlock**：Linux 5.13+ 的安全功能，用於限制程式的檔案存取權限
3. **Codex sandbox 模式**：
   - `workspace-write`：預設，使用 Landlock
   - `danger-full-access`：跳過 sandbox，YOLO mode 使用
4. **Claude vs Codex**：Claude 模式不用 Landlock，所以不會有這個問題
