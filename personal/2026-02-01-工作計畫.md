---
title: å·¥ä½œè¨ˆç•« - Day 1 Claude Proxy é–‹ç™¼
date: 2026-02-01
category: å·¥ä½œè¨ˆç•«
tags: [claude, proxy, testing, æ•™å­¸ç³»çµ±]
---

# 2026-02-01 å·¥ä½œè¨ˆç•« (Day 1)

## ğŸ¯ ä»Šæ—¥ç›®æ¨™

**ä¸»è¦ä»»å‹™**: Claude Proxy é–‹ç™¼ - Day 1
**é ä¼°æ™‚é–“**: 4-5 å°æ™‚
**å®Œæˆæ¨™æº–**: Proxy æœ¬åœ°é‹è¡Œæ­£å¸¸,å¯è™•ç† 20 ä¸¦ç™¼è«‹æ±‚

---

## â° æ™‚é–“è¦åŠƒ

### ä¸Šåˆæ™‚æ®µ (2-2.5 å°æ™‚)

#### 09:00 - 09:30 | å¿«é€Ÿ RPM æ¸¬è©¦æº–å‚™
- [ ] å»ºç«‹ `quick_rpm_test.py` è…³æœ¬
- [ ] è¨­å®šæ¸¬è©¦åƒæ•¸ (RPM 25, 30, 35, 40)
- [ ] æº–å‚™æ¥µçŸ­æç¤ºè©åˆ—è¡¨

#### 09:30 - 10:00 | åŸ·è¡Œ RPM æ¸¬è©¦
- [ ] åŸ·è¡Œæ¸¬è©¦è…³æœ¬
- [ ] å³æ™‚è§€å¯Ÿçµæœ
- [ ] è¨˜éŒ„æˆåŠŸ/å¤±æ•—çš„ RPM ç´šåˆ¥

#### 10:00 - 10:30 | åˆ†ææ¸¬è©¦çµæœ
- [ ] ç¢ºå®šã€Œç©©å®šé€šéã€çš„ RPM å€¼
- [ ] æ±ºå®š proxy çš„å®‰å…¨è¨­å®š
  - MIN_INTERVAL (é æœŸ 6 ç§’)
  - MAX_CONCURRENT (é æœŸ 5-8)

#### 10:30 - 11:00 | çˆ†ç™¼æ¸¬è©¦ (å¯é¸)
- [ ] å»ºç«‹ `classroom_burst_test.py`
- [ ] æ¸¬è©¦ 10, 20, 30 äººåŒæ™‚æå•
- [ ] æ‰¾å‡ºçˆ†ç™¼å®‰å…¨é–¾å€¼

**ä¸Šåˆç”¢å‡º**:
- âœ… ç¢ºå®šå®‰å…¨ RPM è¨­å®š
- âœ… `quick_rpm_test.py` æ¸¬è©¦çµæœ
- âœ… åƒæ•¸æ±ºç­–æ–‡ä»¶

---

### ä¸‹åˆæ™‚æ®µ (2-3 å°æ™‚)

#### 13:00 - 14:30 | Proxy æ ¸å¿ƒé–‹ç™¼
- [ ] å»ºç«‹ `simple_queue_proxy.py`
- [ ] å¯¦ä½œæ ¸å¿ƒåŠŸèƒ½:
  ```python
  âœ… FastAPI æ¡†æ¶è¨­å®š
  âœ… å…¨åŸŸ FIFO ä½‡åˆ—
  âœ… é€Ÿç‡é™åˆ¶å™¨ (å›ºå®šé–“éš”)
  âœ… ä¸¦ç™¼æ§åˆ¶
  âœ… Claude CLI å‘¼å«æ•´åˆ
  ```

#### 14:30 - 15:00 | 429 é‡è©¦æ©Ÿåˆ¶
- [ ] å¯¦ä½œ 429 éŒ¯èª¤åµæ¸¬
- [ ] è‡ªå‹•é‡æ–°åŠ å…¥ä½‡åˆ—
- [ ] 60 ç§’å†·å»æ™‚é–“
- [ ] æ—¥èªŒè¨˜éŒ„

#### 15:00 - 15:30 | æœ¬åœ°æ¸¬è©¦
- [ ] å•Ÿå‹• proxy æœå‹™
  ```bash
  uvicorn simple_queue_proxy:app --port 8082 --reload
  ```
- [ ] æ¸¬è©¦å–®ä¸€è«‹æ±‚
- [ ] æ¸¬è©¦ä½‡åˆ—åŠŸèƒ½
- [ ] æª¢æŸ¥ç‹€æ…‹ç«¯é»

#### 15:30 - 16:00 | ä¸¦ç™¼æ¸¬è©¦
- [ ] å»ºç«‹ç°¡æ˜“æ¸¬è©¦è…³æœ¬
- [ ] æ¨¡æ“¬ 10 å€‹ä¸¦ç™¼è«‹æ±‚
- [ ] æ¨¡æ“¬ 20 å€‹ä¸¦ç™¼è«‹æ±‚
- [ ] è§€å¯Ÿä½‡åˆ—è™•ç†æƒ…æ³

**ä¸‹åˆç”¢å‡º**:
- âœ… `simple_queue_proxy.py` å¯é‹è¡Œ
- âœ… é€šé 20 ä¸¦ç™¼æ¸¬è©¦
- âœ… åŸºæœ¬æ—¥èªŒåŠŸèƒ½

---

## ğŸ“ è©³ç´°ä»»å‹™æ¸…å–®

### Task 1: å¿«é€Ÿ RPM æ¸¬è©¦è…³æœ¬

**æª”æ¡ˆ**: `~/workshop/tools/quick_rpm_test.py`

**æ ¸å¿ƒé‚è¼¯**:
```python
#!/usr/bin/env python3
"""å¿«é€Ÿ RPM æ¸¬è©¦ - é©—è­‰ 25-40 RPM"""

import subprocess
import time
from datetime import datetime

RPM_LEVELS = [25, 30, 35, 40]
TEST_DURATION = 60  # æ¯ç´š 60 ç§’
PROMPTS = ["Hi.", "Ok.", "Yes.", "No.", "Go."]

def test_rpm_level(rpm: int) -> dict:
    """æ¸¬è©¦å–®ä¸€ RPM ç´šåˆ¥"""
    interval = 60.0 / rpm
    expected = int(TEST_DURATION / interval)

    results = {
        "rpm": rpm,
        "sent": 0,
        "success": 0,
        "rate_limited": 0,
        "errors": 0
    }

    start = time.time()
    while time.time() - start < TEST_DURATION:
        # è¨ˆç®—ä¸‹ä¸€å€‹è«‹æ±‚æ™‚é–“
        target = start + (results["sent"] * interval)
        now = time.time()
        if target > now:
            time.sleep(target - now)

        # ç™¼é€è«‹æ±‚
        result = send_request(PROMPTS[results["sent"] % len(PROMPTS)])
        results["sent"] += 1

        if result["status"] == "success":
            results["success"] += 1
        elif result["rate_limited"]:
            results["rate_limited"] += 1
            print(f"âš ï¸ RPM {rpm} è§¸ç™¼é™é€Ÿ!")
            return results  # ç«‹å³åœæ­¢
        else:
            results["errors"] += 1

    return results

# ... å…¶ä»–å¯¦ä½œ
```

**åŸ·è¡Œ**:
```bash
cd ~/workshop/tools
python3 quick_rpm_test.py
```

**é æœŸè¼¸å‡ºæƒ…å¢ƒ 1 (é †åˆ©)**:
```
æ¸¬è©¦ RPM 25... âœ… é€šé (38/38)
æ¸¬è©¦ RPM 30... âœ… é€šé (45/45)
æ¸¬è©¦ RPM 35... âœ… é€šé (53/53)
æ¸¬è©¦ RPM 40... âœ… é€šé (60/60)

çµè«–: å®‰å…¨ RPM â‰¥ 40
å»ºè­°è¨­å®š: MIN_INTERVAL = 1.5s (40 RPM)
```

**é æœŸè¼¸å‡ºæƒ…å¢ƒ 2 (è§¸ç™¼é™é€Ÿ)**:
```
æ¸¬è©¦ RPM 25... âœ… é€šé (38/38)
æ¸¬è©¦ RPM 30... âŒ é™é€Ÿ! (ç¬¬ 23 å€‹è«‹æ±‚è§¸ç™¼ 429)

â¹ï¸ ç«‹å³åœæ­¢æ‰€æœ‰æ¸¬è©¦
âœ… å®‰å…¨ RPM = 25
ğŸ“ ä½¿ç”¨ RPM 25 ä½œç‚º proxy è¨­å®š
ğŸš« ç•¶å¤©æ¸¬è©¦çµæŸ,ä¸å†å‘¼å« API

å»ºè­°è¨­å®š: MIN_INTERVAL = 2.4s (25 RPM,ä¿å®ˆå€¼)
```

**é æœŸè¼¸å‡ºæƒ…å¢ƒ 3 (è·³éæ¸¬è©¦)**:
```
â­ï¸ è·³é RPM æ¸¬è©¦,ä½¿ç”¨ä¿å®ˆè¨­å®š

ä½¿ç”¨å·²é©—è­‰çš„å®‰å…¨å€¼:
- æ ¹æ“š 01-31 æ¸¬è©¦: RPM 20 ç©©å®šé€šé
- å»ºè­°è¨­å®š: MIN_INTERVAL = 3.0s (20 RPM)
```

---

### Task 2: ç°¡æ˜“æ’éšŠ Proxy

**æª”æ¡ˆ**: `~/workshop/tools/simple_queue_proxy.py`

**é—œéµåŠŸèƒ½**:

1. **FastAPI è¨­å®š**
```python
from fastapi import FastAPI, BackgroundTasks
from pydantic import BaseModel
import asyncio

app = FastAPI(title="Claude Queue Proxy")

class ChatRequest(BaseModel):
    student_id: str
    message: str
```

2. **å…¨åŸŸä½‡åˆ—**
```python
from collections import deque

# å…¨åŸŸç‹€æ…‹
request_queue = deque()
active_requests = 0
MAX_CONCURRENT = 5
MIN_INTERVAL = 6.0
last_request_time = 0
stats = {
    "total_processed": 0,
    "total_429": 0,
    "total_errors": 0
}
```

3. **API ç«¯é»**
```python
@app.post("/chat")
async def chat(req: ChatRequest):
    request_queue.append({
        "student_id": req.student_id,
        "message": req.message,
        "timestamp": time.time()
    })

    return {
        "status": "queued",
        "position": len(request_queue),
        "estimated_wait": len(request_queue) * MIN_INTERVAL
    }

@app.get("/status")
async def status():
    return {
        "queue_size": len(request_queue),
        "active_requests": active_requests,
        "stats": stats
    }
```

4. **èƒŒæ™¯è™•ç†**
```python
@app.on_event("startup")
async def startup():
    asyncio.create_task(process_queue())

async def process_queue():
    global active_requests, last_request_time

    while True:
        if request_queue and active_requests < MAX_CONCURRENT:
            # ç¢ºä¿æœ€å°é–“éš”
            elapsed = time.time() - last_request_time
            if elapsed < MIN_INTERVAL:
                await asyncio.sleep(MIN_INTERVAL - elapsed)

            # è™•ç†è«‹æ±‚
            req = request_queue.popleft()
            active_requests += 1
            last_request_time = time.time()

            asyncio.create_task(execute_request(req))

        await asyncio.sleep(0.1)
```

**æ¸¬è©¦**:
```bash
# çµ‚ç«¯ 1: å•Ÿå‹•æœå‹™
uvicorn simple_queue_proxy:app --port 8082 --reload

# çµ‚ç«¯ 2: æ¸¬è©¦
curl -X POST http://localhost:8082/chat \
  -H "Content-Type: application/json" \
  -d '{"student_id":"test01","message":"ä»€éº¼æ˜¯ Python?"}'

# æŸ¥çœ‹ç‹€æ…‹
curl http://localhost:8082/status
```

---

### Task 3: ä¸¦ç™¼æ¸¬è©¦è…³æœ¬

**æª”æ¡ˆ**: `~/workshop/tools/test_concurrent.py`

```python
#!/usr/bin/env python3
"""æ¸¬è©¦ proxy ä¸¦ç™¼è™•ç†èƒ½åŠ›"""

import asyncio
import aiohttp

async def send_request(session, student_id):
    url = "http://localhost:8082/chat"
    data = {
        "student_id": student_id,
        "message": "æ¸¬è©¦è¨Šæ¯"
    }

    async with session.post(url, json=data) as resp:
        result = await resp.json()
        print(f"{student_id}: {result['status']}, ä½‡åˆ—ä½ç½® {result['position']}")

async def test_concurrent(count):
    async with aiohttp.ClientSession() as session:
        tasks = [
            send_request(session, f"student_{i:02d}")
            for i in range(count)
        ]
        await asyncio.gather(*tasks)

if __name__ == "__main__":
    print("æ¸¬è©¦ 10 å€‹ä¸¦ç™¼...")
    asyncio.run(test_concurrent(10))

    print("\nç­‰å¾…è™•ç†...")
    time.sleep(70)

    print("\næ¸¬è©¦ 20 å€‹ä¸¦ç™¼...")
    asyncio.run(test_concurrent(20))
```

---

## âœ… é©—æ”¶æ¨™æº–

### ä¸Šåˆå®Œæˆ
- [ ] `quick_rpm_test.py` è…³æœ¬å®Œæˆ
- [ ] æ¸¬è©¦åŸ·è¡Œå®Œæˆ,æ‰¾å‡ºå®‰å…¨ RPM
- [ ] æ±ºå®š MIN_INTERVAL å’Œ MAX_CONCURRENT åƒæ•¸

### ä¸‹åˆå®Œæˆ
- [ ] `simple_queue_proxy.py` å¯æ­£å¸¸å•Ÿå‹•
- [ ] POST /chat ç«¯é»é‹ä½œæ­£å¸¸
- [ ] GET /status å›å‚³æ­£ç¢ºè³‡è¨Š
- [ ] ä½‡åˆ—æ©Ÿåˆ¶é‹ä½œæ­£å¸¸
- [ ] å›ºå®šé–“éš”ç™¼é€è«‹æ±‚
- [ ] 20 å€‹ä¸¦ç™¼è«‹æ±‚æ¸¬è©¦é€šé

### å“è³ªæ¨™æº–
- [ ] æ²’æœ‰ 429 éŒ¯èª¤ (åœ¨å®‰å…¨ RPM ä¸‹)
- [ ] æ‰€æœ‰è«‹æ±‚éƒ½èƒ½è™•ç†å®Œæˆ
- [ ] æ—¥èªŒè¨˜éŒ„æ¸…æ¥š
- [ ] ç¨‹å¼ç¢¼æœ‰é©ç•¶è¨»è§£

---

## ğŸ“Š æˆåŠŸæŒ‡æ¨™

**é‡åŒ–æŒ‡æ¨™**:
- æ¸¬è©¦ 4 å€‹ RPM ç´šåˆ¥ (25, 30, 35, 40)
- æ‰¾å‡ºè‡³å°‘ 1 å€‹ç©©å®šé€šéçš„ RPM
- è™•ç† 20 å€‹ä¸¦ç™¼è«‹æ±‚ç„¡éŒ¯èª¤
- ä½‡åˆ—è™•ç†æ™‚é–“ < 2 åˆ†é˜ (20 è«‹æ±‚)

**è³ªåŒ–æŒ‡æ¨™**:
- Proxy é‹ä½œç©©å®š
- ç¨‹å¼ç¢¼çµæ§‹æ¸…æ™°
- æ˜“æ–¼èª¿æ•´åƒæ•¸

---

## ğŸ”§ ç’°å¢ƒæº–å‚™

### éœ€è¦å®‰è£çš„å¥—ä»¶
```bash
pip3 install fastapi uvicorn aiohttp pydantic
```

### æª¢æŸ¥ Claude CLI
```bash
# ç¢ºèªå¯ç”¨
~/.nvm/versions/node/v20.20.0/bin/claude --version

# æ¸¬è©¦åŸ·è¡Œ
~/.nvm/versions/node/v20.20.0/bin/claude -p "Hi" --output-format json
```

### å·¥ä½œç›®éŒ„
```bash
cd ~/workshop/tools
mkdir -p test_results/day1
```

---

## ğŸ“ é æœŸç”¢å‡º

### æª”æ¡ˆç”¢å‡º
1. `~/workshop/tools/quick_rpm_test.py` (æ–°)
2. `~/workshop/tools/classroom_burst_test.py` (å¯é¸)
3. `~/workshop/tools/simple_queue_proxy.py` (æ–°)
4. `~/workshop/tools/test_concurrent.py` (æ–°)
5. `~/workshop/tools/test_results/day1/rpm_test_results.json` (æ¸¬è©¦çµæœ)

### æ±ºç­–ç”¢å‡º
- **ç¢ºå®šçš„ MIN_INTERVAL å€¼** (é æœŸ: 2-6 ç§’)
- **ç¢ºå®šçš„ MAX_CONCURRENT å€¼** (é æœŸ: 5-8)
- **çˆ†ç™¼å®‰å…¨é–¾å€¼** (é æœŸ: 15-20 äºº)

### çŸ¥è­˜ç”¢å‡º
- RPM æ¸¬è©¦ç¶“é©—
- Proxy æ¶æ§‹ç†è§£
- FastAPI å¯¦ä½œç¶“é©—

---

## âš ï¸ æ³¨æ„äº‹é …

### æ¸¬è©¦å®‰å…¨ âš ï¸ é‡è¦!
- **è§¸ç™¼ 429 ç«‹å³åœæ­¢æ¸¬è©¦,ç›´æ¥çµæŸç•¶å¤©ä»»å‹™**
- ä¸ç¹¼çºŒå˜—è©¦æ›´é«˜ RPM
- ä¸ç­‰å¾… 60 åˆ†é˜,ç›´æ¥çµæŸæ‰€æœ‰æ¸¬è©¦å·¥ä½œ
- ä½¿ç”¨æ¥µçŸ­æç¤ºè©é¿å…æ¶ˆè€— tokens
- ä¸è¦æ¸¬è©¦éé«˜çš„ RPM (é¿å…å°é–)

**å¦‚æœè§¸ç™¼é™é€Ÿ**:
1. â¹ï¸ ç«‹å³åœæ­¢ç•¶å‰æ¸¬è©¦
2. ğŸ“ è¨˜éŒ„æœ€å¾ŒæˆåŠŸçš„ RPM
3. âœ… ä½¿ç”¨æœ€å¾ŒæˆåŠŸçš„ RPM ä½œç‚º proxy è¨­å®š
4. ğŸš« ç•¶å¤©ä¸å†é€²è¡Œä»»ä½• Claude API æ¸¬è©¦
5. â­ï¸ ç›´æ¥é€²å…¥ Day 2 (éƒ¨ç½²éšæ®µ)

### ç¨‹å¼ç¢¼å“è³ª
- åŠ ä¸Šé©ç•¶çš„éŒ¯èª¤è™•ç†
- è¨˜éŒ„æ¸…æ¥šçš„æ—¥èªŒ
- åƒæ•¸å¯é…ç½® (ä¸è¦å¯«æ­»)

### æ™‚é–“æ§åˆ¶
- ä¸Šåˆè¶…é 2.5 å°æ™‚å°±è·³éçˆ†ç™¼æ¸¬è©¦
- ä¸‹åˆå°ˆæ³¨åœ¨ proxy æ ¸å¿ƒåŠŸèƒ½
- ä¸è¦éåº¦å„ªåŒ–

---

## ğŸ¯ æ˜æ—¥é å‘Š (Day 2)

å¦‚æœ Day 1 é †åˆ©å®Œæˆ,æ˜å¤©å°‡:
1. å°‡ proxy éƒ¨ç½²åˆ° rpi5
2. è¨­å®š systemd æœå‹™
3. å»ºç«‹åŸºæœ¬ 429 ç›£æ§

---

## ğŸ“ éœ€è¦å”åŠ©æ™‚

**å•é¡Œæ’æŸ¥**:
- FastAPI æ–‡ä»¶: https://fastapi.tiangolo.com/
- Claude CLI å•é¡Œ: æŸ¥çœ‹ `~/.claude/` è¨­å®š
- Async å•é¡Œ: Python asyncio å®˜æ–¹æ–‡ä»¶

**å‚™ç”¨æ–¹æ¡ˆ**:
- **å¦‚æœæ¸¬è©¦è§¸ç™¼é™é€Ÿ** â†’ ç«‹å³çµæŸç•¶å¤©å·¥ä½œ,ä½¿ç”¨ä¸Šæ¬¡æˆåŠŸæ¸¬è©¦çš„ RPM 20 ä½œç‚º proxy è¨­å®š (MIN_INTERVAL = 3s)
- å¦‚æœæ™‚é–“ä¸å¤  â†’ å„ªå…ˆå®Œæˆ proxy æ ¸å¿ƒ,æ¸¬è©¦å¯ç°¡åŒ–æˆ–è·³é
- å¦‚æœé‡åˆ°æŠ€è¡“å•é¡Œ â†’ è¨˜éŒ„ä¸¦ç¹¼çºŒ,ä¸è¦å¡ä½

**ç„¡æ¸¬è©¦æƒ…æ³ä¸‹çš„å‚™æ¡ˆ**:
- ç›´æ¥ä½¿ç”¨ä¿å®ˆè¨­å®š: MIN_INTERVAL = 6s (10 RPM)
- é€™æ˜¯ç¶“éé©—è­‰çš„å®‰å…¨å€¼
- Day 3 å£“åŠ›æ¸¬è©¦æ™‚å†æ ¹æ“šå¯¦éš›æƒ…æ³å¾®èª¿

---

**å»ºç«‹æ™‚é–“**: 2026-01-31 æ™šä¸Š
**åŸ·è¡Œæ—¥æœŸ**: 2026-02-01
**é è¨ˆå®Œæˆæ™‚é–“**: 16:00
**ä¿¡å¿ƒæŒ‡æ•¸**: â­â­â­â­â­ (5/5)

ğŸš€ æº–å‚™å¥½é–‹å§‹ Day 1 äº†!
