---
title: 工作日誌 - Claude Max RPM 測試分析與系統規劃
date: 2026-01-31
category: 工作日誌
tags: [claude, rpm, rate-limit, testing, 教學系統, api-management]
---

# 2026-01-31 工作日誌

## 主要任務：Claude Max RPM 測試歷史趨勢分析與進階系統規劃

### 1. Claude Max RPM 測試歷史分析

**背景**：
- 每日凌晨 02:00 自動執行 RPM 測試 (cron)
- 測試腳本：`~/workshop/tools/claude_max_rpm_test.py`
- 測試目標：精確測定 Claude Max 的 RPM 限制

**今日執行結果 (2026-01-31 02:00)**：
```
測試時長: 25.4 分鐘
總請求數: 106 次
成功率: 100%
Token 使用: 1,086 tokens
限速觸發: ❌ 無

階段一 - RPM 測試:
  RPM 1-20: 全部通過 ✅

階段二 - 並發測試:
  並發 5-20: 全部通過 ✅

階段三 - 恢復測試:
  未觸發限速，跳過
```

**結論**: RPM 限制 > 20，遠高於預期

---

### 2. 歷史測試趨勢分析

分析了 4 次歷史測試 (01-28 至 01-31)：

| 日期 | 測試類型 | 任務數 | 成功率 | Tokens | 限速? |
|------|---------|-------|--------|--------|------|
| 01-28 23:19 | 任務測試 | 10 | 90% | 38K | ❌ |
| 01-29 02:00 | 大規模測試 | 50 | 86% | **170K** | ❌ |
| 01-30 01:00 | 連續測試 | 17 | 94% | 10K | ✅ **限速!** |
| 01-31 02:00 | 並行 RPM | 106 | 100% | 1K | ❌ |

**關鍵發現**：

1. **限速觸發的真相**
   - 01-30 以 ~3.8 RPM 觸發限速
   - 01-31 以 20 RPM 未觸發限速
   - **差異**: 固定間隔 vs 連續請求

2. **限速機制推論**
   ```
   ❌ 不是: 純 RPM 限制 (20 RPM 通過)
   ❌ 不是: TPM 限制 (170K tokens 通過)
   ✅ 可能: 滑動視窗 + 請求密度綜合判斷
   ```

3. **Token 使用量影響**
   - 01-29: 3,961 tokens/任務 → 無限速
   - 01-30: 656 tokens/任務 → **限速!**
   - 01-31: 10 tokens/任務 → 無限速
   - **結論**: Token 數不是主要限速因素

**趨勢報告位置**：
- `~/workshop/tools/test_results/claude_max/trend_analysis.md`

---

### 3. 進階測試與系統開發規劃

基於趨勢分析，制定了完整的測試與系統開發計劃：

#### **測試方向 (4 項)**

**3.1 高 RPM 測試** (`claude_max_high_rpm_test.py`)
- 測試 RPM 25-100
- 使用二分搜尋法精確定位上限
- 自適應測試策略

**3.2 模式對比測試** (`claude_max_pattern_test.py`)
- 固定間隔 vs 隨機間隔 vs 爆發模式
- 驗證「請求規律性」假設
- 測試矩陣: 3 RPM × 3 模式 = 9 組

**3.3 爆發測試** (`claude_max_burst_test.py`)
- 模擬教室場景 (20 人同時提問)
- 找出安全爆發閾值
- 測試場景:
  - 課堂突發提問 (20 人瞬間)
  - 學員自主練習 (8 人分批)
  - 批改作業模式 (30 人批次)

**3.4 標頭記錄增強**
- 解析完整 rate limit HTTP 標頭
- 發現隱藏限制參數
- 整合到所有測試腳本

#### **系統開發 (3 項)**

**3.5 排隊系統**
- `queue_manager.py` - 核心排隊邏輯
  - 速率限制器 (滑動視窗)
  - 優先級佇列
  - 自動 429 重試
- `queue_service.py` - FastAPI REST API
  - 部署於 rpi5
  - 提供 `/submit`, `/status` 端點

**3.6 監控系統**
- `rate_limit_monitor.py` - 429 錯誤監控
  - 即時錯誤追蹤
  - Telegram 告警整合
  - 統計分析
- `dashboard.py` - Web 監控儀表板
  - 即時狀態顯示
  - 歷史趨勢圖表

**3.7 API Key 輪替**
- `api_key_rotator.py` - 多 key 管理
  - 自動切換備用 key
  - 限速冷卻機制
  - 成功率追蹤
  - 支援 3+ API keys

---

### 4. 教學場景影響評估

**情境**: 20 位學員同時使用 Claude Max

**風險評估**:
- ✅ 安全: 學員間隔 > 30s，RPM < 10
- ⚠️ 高風險: 20 人同時點擊執行，不規則爆發

**推薦配置**:
```python
排隊系統配置:
- 最小間隔: 6 秒 (10 RPM 安全值)
- 最大並發: 10 個請求
- 429 重試: 等待 60s 後重試
- 請求排隊: 啟用
```

**系統架構**:
```
學員端 (1-20)
    ↓
rpi5 Proxy Server
  ├─ Queue Manager (排隊)
  ├─ Rate Monitor (監控)
  └─ Key Rotator (輪替)
    ↓
Claude API (3 keys)
```

---

### 5. 時程規劃

**Week 1 (3-5 天)**: 測試階段
- 開發 & 執行 4 個進階測試腳本
- 撰寫測試報告

**Week 2 (5-7 天)**: 系統開發
- 開發排隊、監控、輪替 3 大系統
- 本地測試 & 整合

**Week 3 (2-3 天)**: 部署驗證
- 部署到 rpi5
- 20 學員壓力測試
- 正式上線

**預計完成**: 2026-02-15

---

### 6. 成功指標 (KPI)

**測試階段**:
- [ ] 精確測定 RPM 上限 (誤差 ±5)
- [ ] 完成 3 種模式對比測試
- [ ] 記錄至少 100 次請求的完整標頭
- [ ] 生成完整測試報告

**系統階段**:
- [ ] 排隊系統穩定運行 > 24 小時
- [ ] 429 錯誤率 < 1%
- [ ] 請求平均延遲 < 10 秒
- [ ] 成功處理 20 並發學員

---

## 產出檔案

**今日建立**:
1. `~/workshop/tools/test_results/claude_max/trend_analysis.md`
   - 歷史測試趨勢分析報告
   - 包含 4 次測試對比
   - 限速機制推論
   - 教學場景評估

2. `~/workshop/tools/claude_rpm_advanced_plan.md`
   - 進階測試與系統開發完整規劃
   - 7 個模組的詳細設計
   - 包含完整程式碼範例
   - 時程與 KPI 規劃

**測試結果**:
- `~/workshop/tools/test_results/claude_max/claude_max_rpm_20260131_020001/`
  - summary.json
  - phase1_results.json (33KB)
  - phase2_results.json (14KB)
  - phase3_results.json

**Cron 排程**:
```
0 2 31 1 * /home/ac-mac/workshop/tools/run_claude_max_rpm_test.sh
```

---

## 學到的知識

### 1. Claude Max 的限速機制

**發現**:
- Claude Max 使用「智能限速」而非簡單的 RPM 限制
- 允許固定節奏的高頻請求 (20 RPM 通過)
- 阻擋不規則的連續爆發請求 (3.8 RPM 被限)

**關鍵洞察**:
> 請求的「規律性」比「總頻率」更重要

### 2. 測試方法學

**錯誤假設**:
- ❌ Token 使用量是主要限速因素
- ❌ 純 RPM 或 TPM 限制

**正確假設**:
- ✅ 滑動視窗 + 請求密度綜合判斷
- ✅ 固定間隔請求的容忍度更高
- ✅ 爆發模式更容易觸發限速

### 3. 系統設計原則

**排隊系統核心**:
```python
速率限制器 + 優先級佇列 + 自動重試 = 穩健系統
```

**監控關鍵**:
- 即時 429 錯誤追蹤
- 自動告警 (Telegram)
- 歷史趨勢分析

**容災策略**:
- 多 API key 輪替
- 限速冷卻機制
- 自動降級處理

---

## 下一步行動

### 立即執行 (本週)
- [ ] 開發 `claude_max_high_rpm_test.py`
- [ ] 執行高 RPM 測試 (25-100)
- [ ] 分析測試結果

### 短期目標 (Week 1-2)
- [ ] 完成 4 個進階測試腳本
- [ ] 開發排隊系統核心
- [ ] 開發監控系統

### 中期目標 (Week 3)
- [ ] 部署到 rpi5
- [ ] 20 學員壓力測試
- [ ] 正式上線教學系統

---

## 相關連結

**測試腳本**:
- 現有: `~/workshop/tools/claude_max_rpm_test.py`
- Cron: `~/workshop/tools/run_claude_max_rpm_test.sh`

**測試結果**:
- 目錄: `~/workshop/tools/test_results/claude_max/`
- 日誌: `~/workshop/tools/test_results/claude_max/cron.log`

**規劃文件**:
- 趨勢分析: `~/workshop/tools/test_results/claude_max/trend_analysis.md`
- 進階規劃: `~/workshop/tools/claude_rpm_advanced_plan.md`

**相關服務**:
- rpi5 Proxy: 待部署
- 監控儀表板: 待開發

---

## 備註

**測試注意事項**:
- 使用極短提示詞避免消耗過多 tokens
- 固定間隔測試避免觸發限速
- 記錄完整的 HTTP 標頭資訊

**系統部署考量**:
- rpi5 效能需驗證
- 多 API key 需申請備用帳號
- Telegram Bot 整合需設定 token

**風險管理**:
- 測試可能觸發帳號封鎖 → 使用安全頻率
- Claude API 政策可能變更 → 定期重測
- rpi5 效能可能不足 → 監控資源使用

---

**工作時長**: ~3 小時
**主要產出**: 2 份完整規劃文件 + 測試結果分析
**下次重點**: 開始實作進階測試腳本
