---
title: Super Happy Coder - äº’å‹•é€²åº¦é¡¯ç¤ºèˆ‡å›é¥‹è¿­ä»£æ©Ÿåˆ¶è¨­è¨ˆ
date: 2026-01-29
category: tech
tags: [agent, UX, feedback-loop, progress, super-happy-coder, äº’å‹•è¨­è¨ˆ]
source: è¨­è¨ˆè¨è«–
---

# äº’å‹•é€²åº¦é¡¯ç¤ºèˆ‡å›é¥‹è¿­ä»£æ©Ÿåˆ¶è¨­è¨ˆ

## æ‘˜è¦
å…©å€‹æ ¸å¿ƒéœ€æ±‚çš„æ•´åˆè¨­è¨ˆï¼š(1) ä»»å‹™åŸ·è¡Œæ™‚çš„å³æ™‚äº’å‹•é€²åº¦é¡¯ç¤ºï¼Œçµåˆ Happy çš„å¯è¦‹æ€§èˆ‡ Clawdbot çš„ä¸æ‰“æ“¾å“²å­¸ï¼›(2) ç”¨æˆ¶èª¿æ•´è«‹æ±‚çš„å›é¥‹è¿­ä»£æ©Ÿåˆ¶ï¼Œå°‡ä¿®æ”¹è¨˜éŒ„è½‰åŒ–ç‚ºæ¨¡çµ„è¦æ ¼çš„æŒçºŒå„ªåŒ–ã€‚

## é—œéµè¦é»
- ç”¨æˆ¶åœ¨åŸ·è¡Œéç¨‹ä¸­èƒ½å³æ™‚çœ‹åˆ°ä»»å‹™é€²åº¦ã€ç•¶å‰å‹•ä½œã€å®Œæˆé …ç›®
- ä¸éœ€è¦ç¢ºèªçš„éƒ¨åˆ†æ¡é è¨­è¦æ ¼ç›´æ¥è·‘é€šï¼Œç”¨æˆ¶æœ‰ç–‘æ…®å¯éš¨æ™‚ä¸­æ–·
- æ‰€æœ‰è¼¸å…¥/è¼¸å‡º/èª¿æ•´éƒ½æœƒè¨˜éŒ„ï¼Œå½¢æˆå›é¥‹é–‰ç’°
- å¾Œå°ç®¡ç†è€…å¯æ±ºå®šæ˜¯å¦å°‡å›é¥‹è¿­ä»£åˆ°æ¨¡çµ„è¦æ ¼

---

## ä¸€ã€äº’å‹•é€²åº¦é¡¯ç¤ºç³»çµ±ï¼ˆTask Progress UXï¼‰

### 1.1 è¨­è¨ˆå“²å­¸

çµåˆå…©å¥—ç³»çµ±çš„å„ªé»ï¼š

| é¢å‘ | Happy é¢¨æ ¼ | Clawdbot é¢¨æ ¼ | æ•´åˆè¨­è¨ˆ |
|------|-----------|--------------|---------|
| å¯è¦‹æ€§ | é«˜ - é¡¯ç¤ºä»»å‹™æ¸…å–®ã€é€é …æ‰“å‹¾ | ä½ - éœé»˜åŸ·è¡Œåˆ°åº• | é«˜ - å³æ™‚é¡¯ç¤ºä½†ä¸è¦æ±‚äº’å‹• |
| æ‰“æ“¾ç¨‹åº¦ | ä¸­ - æœ‰æ™‚éœ€ç¢ºèª | ä½ - å¹¾ä¹ä¸å• | ä½ - åªåœ¨é–‹å§‹æ™‚ç¢ºèªç›®æ¨™ï¼Œä¹‹å¾Œä¸å• |
| ä¸­æ–·æ©Ÿåˆ¶ | æœ‰ | ç„¡ | æœ‰ - ç”¨æˆ¶å¯éš¨æ™‚æŒ‰ä¸­æ–· |
| æƒ…ç·’åƒ¹å€¼ | é«˜ | ä½ | é«˜ - è®“ç”¨æˆ¶æ„Ÿå—åˆ°ã€Œå®ƒåœ¨èªçœŸåšäº‹ã€ |

### 1.2 äº’å‹•æµç¨‹

```
ç”¨æˆ¶ç™¼é€è«‹æ±‚
    â†“
[Phase 0] ç¢ºèªéšæ®µï¼ˆå”¯ä¸€éœ€è¦äº’å‹•çš„åœ°æ–¹ï¼‰
    â†’ é¡¯ç¤ºï¼šã€Œæ”¶åˆ°ï¼æˆ‘ç†è§£ä½ è¦ XXXï¼Œå°‡ä½¿ç”¨ [M2 ç¶²ç«™ç”Ÿæˆ] ä¾†åŸ·è¡Œã€
    â†’ é¡¯ç¤ºï¼šé è¨ˆæ­¥é©Ÿæ¸…å–®
    â†’ ã€Œé–‹å§‹åŸ·è¡Œï¼Ÿã€/ 3 ç§’ç„¡å›æ‡‰è‡ªå‹•é–‹å§‹
    â†“
[Phase 1-N] åŸ·è¡Œéšæ®µï¼ˆç´”é¡¯ç¤ºï¼Œä¸æ‰“æ“¾ï¼‰
    â†’ æ¯å€‹æ­¥é©Ÿé–‹å§‹æ™‚ï¼šã€Œâ³ [2/6] ç”Ÿæˆå°ˆæ¡ˆéª¨æ¶...ã€
    â†’ æ€è€ƒéç¨‹æ‘˜è¦ï¼šã€Œæ­£åœ¨åˆ†æéœ€æ±‚ï¼Œè­˜åˆ¥åˆ° 3 å€‹æ ¸å¿ƒåŠŸèƒ½...ã€
    â†’ æ­¥é©Ÿå®Œæˆæ™‚ï¼šã€Œâœ… [2/6] å°ˆæ¡ˆéª¨æ¶å·²ç”Ÿæˆï¼ˆ12 å€‹æª”æ¡ˆï¼‰ã€
    â†’ ç”¨æˆ¶å¯éš¨æ™‚ç™¼é€ /cancel ä¸­æ–·
    â†“
[Phase Final] å®Œæˆéšæ®µ
    â†’ é¡¯ç¤ºï¼šå®Œæˆæ‘˜è¦ + æˆæœé€£çµ + å“è³ªåˆ†æ•¸
    â†’ ã€Œéœ€è¦èª¿æ•´å—ï¼Ÿç›´æ¥å‘Šè¨´æˆ‘è¦æ”¹ä»€éº¼ã€
```

### 1.3 è¨Šæ¯æ ¼å¼è¨­è¨ˆ

#### ä»»å‹™é–‹å§‹è¨Šæ¯
```
ğŸš€ ä»»å‹™å•Ÿå‹•ï¼šç¶²ç«™ç”Ÿæˆèˆ‡éƒ¨ç½²

ğŸ“‹ åŸ·è¡Œè¨ˆç•«ï¼š
  1. åˆ†æéœ€æ±‚
  2. ç”Ÿæˆå°ˆæ¡ˆ
  3. é©—è­‰ç¨‹å¼ç¢¼
  4. å»ºç«‹ Repo
  5. éƒ¨ç½²ç¶²ç«™
  6. é©—è­‰éƒ¨ç½²

ğŸ”§ ä½¿ç”¨æ¨¡çµ„ï¼šM2 ç¶²ç«™ç”Ÿæˆèˆ‡éƒ¨ç½²
â± é ä¼°ï¼š6 å€‹æ­¥é©Ÿ

â–¶ï¸ é–‹å§‹åŸ·è¡Œ...
```

#### æ­¥é©Ÿé€²è¡Œä¸­è¨Šæ¯
```
â³ [2/6] ç”Ÿæˆå°ˆæ¡ˆéª¨æ¶
  ğŸ’­ ä½¿ç”¨ React + TailwindCSS æ¨¡æ¿
  ğŸ“ æ­£åœ¨å»ºç«‹å…ƒä»¶çµæ§‹...
```

#### æ­¥é©Ÿå®Œæˆè¨Šæ¯ï¼ˆç°¡æ½”ï¼Œä¸æ´—ç‰ˆï¼‰
```
âœ… [2/6] å°ˆæ¡ˆéª¨æ¶å·²ç”Ÿæˆ â†’ 12 å€‹æª”æ¡ˆ
â³ [3/6] é©—è­‰ç¨‹å¼ç¢¼...
```

#### ä»»å‹™å®Œæˆè¨Šæ¯
```
ğŸ‰ ä»»å‹™å®Œæˆï¼

ğŸ“Š åŸ·è¡Œæ‘˜è¦ï¼š
  âœ… 6/6 æ­¥é©Ÿå®Œæˆ
  â± è€—æ™‚ 45 ç§’
  ğŸ† å“è³ªåˆ†æ•¸ï¼š0.95

ğŸ“¦ æˆæœï¼š
  â€¢ GitHub: https://github.com/...
  â€¢ ç¶²ç«™: https://xxx.pages.dev
  â€¢ æª”æ¡ˆæ•¸ï¼š12

ğŸ’¬ éœ€è¦èª¿æ•´å—ï¼Ÿç›´æ¥å‘Šè¨´æˆ‘è¦æ”¹ä»€éº¼
```

### 1.4 æŠ€è¡“å¯¦ä½œæ–¹æ¡ˆ

#### Telegram Bot æ¨é€ï¼ˆä¸»è¦é€šé“ï¼‰

```
TG Bot â†â”€â”€ Progress Events â†â”€â”€ Redis Pub/Sub â†â”€â”€ Agent Executor
```

æ ¸å¿ƒå…ƒä»¶ï¼š

```python
# progress_emitter.py - é€²åº¦äº‹ä»¶ç™¼å°„å™¨

class ProgressEmitter:
    """
    è² è²¬å°‡ Agent åŸ·è¡Œé€²åº¦æ¨é€åˆ°ç”¨æˆ¶ç«¯ã€‚
    é€é Redis Pub/Sub ç™¼é€äº‹ä»¶ï¼ŒTG Bot è¨‚é–±å¾Œè½‰ç™¼çµ¦ç”¨æˆ¶ã€‚
    """

    def __init__(self, redis_client):
        self.redis = redis_client

    def emit(self, student_id: str, event: dict):
        """ç™¼é€é€²åº¦äº‹ä»¶"""
        channel = f"progress:{student_id}"
        self.redis.publish(channel, json.dumps(event, ensure_ascii=False))
        # åŒæ™‚å¯«å…¥ hash ä¾› polling æŸ¥è©¢
        self.redis.hset(f"progress_state:{student_id}", mapping={
            'last_event': json.dumps(event, ensure_ascii=False),
            'updated_at': datetime.now().isoformat()
        })

    def task_started(self, student_id, agent, steps):
        self.emit(student_id, {
            'type': 'task_started',
            'agent_id': agent.id,
            'agent_name': agent.name,
            'steps': [{'id': s.id, 'name': s.name} for s in steps],
            'total': len(steps)
        })

    def step_started(self, student_id, step_idx, step, total, thinking=''):
        self.emit(student_id, {
            'type': 'step_started',
            'step_idx': step_idx,
            'step_id': step.id,
            'step_name': step.name,
            'total': total,
            'thinking': thinking
        })

    def step_completed(self, student_id, step_idx, step, total, summary=''):
        self.emit(student_id, {
            'type': 'step_completed',
            'step_idx': step_idx,
            'step_id': step.id,
            'step_name': step.name,
            'total': total,
            'summary': summary
        })

    def task_completed(self, student_id, execution):
        self.emit(student_id, {
            'type': 'task_completed',
            'execution_id': execution.execution_id,
            'quality_score': execution.quality_score,
            'outputs': execution.outputs,
            'duration_ms': int((execution.completed_at - execution.started_at).total_seconds() * 1000),
            'issues': execution.issues
        })

    def task_failed(self, student_id, execution, error):
        self.emit(student_id, {
            'type': 'task_failed',
            'execution_id': execution.execution_id,
            'error': error,
            'step_idx': execution.current_step_idx
        })
```

#### Agent Executor æ•´åˆé»

åœ¨ `agent_executor.py` çš„ `execute()` æ–¹æ³•ä¸­æ³¨å…¥ ProgressEmitterï¼š

```python
async def execute(self, agent_id, user_request, student_id, inputs=None):
    # ... å»ºç«‹ execution ...

    # ç™¼é€ä»»å‹™é–‹å§‹äº‹ä»¶
    self.emitter.task_started(student_id, agent, agent.steps)

    for idx, step in enumerate(agent.steps):
        # ç™¼é€æ­¥é©Ÿé–‹å§‹äº‹ä»¶
        self.emitter.step_started(student_id, idx + 1, step, len(agent.steps))

        result = await self._execute_step(execution, step)

        # ç™¼é€æ­¥é©Ÿå®Œæˆäº‹ä»¶
        summary = self._extract_summary(result)
        self.emitter.step_completed(student_id, idx + 1, step, len(agent.steps), summary)

    # ç™¼é€ä»»å‹™å®Œæˆäº‹ä»¶
    self.emitter.task_completed(student_id, execution)
```

#### TG Bot è¨‚é–±ç«¯

```python
# tg_progress_listener.py

import threading

def start_progress_listener(bot, redis_client):
    """å•Ÿå‹•èƒŒæ™¯åŸ·è¡Œç·’ç›£è½é€²åº¦äº‹ä»¶"""

    def listener():
        pubsub = redis_client.pubsub()
        pubsub.psubscribe("progress:*")

        for message in pubsub.listen():
            if message['type'] != 'pmessage':
                continue

            channel = message['channel'].decode()
            student_id = channel.split(':')[1]
            event = json.loads(message['data'])

            # æ ¹æ“šäº‹ä»¶é¡å‹æ ¼å¼åŒ– TG è¨Šæ¯
            text = format_progress_message(event)
            if text:
                chat_id = get_chat_id(student_id)
                bot.send_message(chat_id, text, parse_mode='Markdown')

    thread = threading.Thread(target=listener, daemon=True)
    thread.start()

def format_progress_message(event):
    """å°‡é€²åº¦äº‹ä»¶æ ¼å¼åŒ–ç‚º TG è¨Šæ¯"""
    t = event['type']

    if t == 'task_started':
        steps_text = '\n'.join(
            f"  {i+1}. {s['name']}"
            for i, s in enumerate(event['steps'])
        )
        return (
            f"ğŸš€ *ä»»å‹™å•Ÿå‹•ï¼š{event['agent_name']}*\n\n"
            f"ğŸ“‹ åŸ·è¡Œè¨ˆç•«ï¼š\n{steps_text}\n\n"
            f"â–¶ï¸ é–‹å§‹åŸ·è¡Œ..."
        )

    elif t == 'step_started':
        thinking = f"\n  ğŸ’­ {event['thinking']}" if event.get('thinking') else ''
        return f"â³ [{event['step_idx']}/{event['total']}] {event['step_name']}...{thinking}"

    elif t == 'step_completed':
        summary = f" â†’ {event['summary']}" if event.get('summary') else ''
        return f"âœ… [{event['step_idx']}/{event['total']}] {event['step_name']}{summary}"

    elif t == 'task_completed':
        return (
            f"ğŸ‰ *ä»»å‹™å®Œæˆï¼*\n\n"
            f"ğŸ† å“è³ªåˆ†æ•¸ï¼š{event['quality_score']}\n"
            f"â± è€—æ™‚ï¼š{event['duration_ms'] // 1000} ç§’\n\n"
            f"ğŸ’¬ éœ€è¦èª¿æ•´å—ï¼Ÿç›´æ¥å‘Šè¨´æˆ‘è¦æ”¹ä»€éº¼"
        )

    elif t == 'task_failed':
        return f"âŒ ä»»å‹™å¤±æ•—ï¼ˆæ­¥é©Ÿ {event['step_idx']}ï¼‰ï¼š{event['error']}"

    return None
```

#### HTTP APIï¼ˆå‚™ç”¨é€šé“ - SSEï¼‰

```python
@app.route('/api/v1/progress/<student_id>/stream')
def progress_stream(student_id):
    """SSE ä¸²æµé€²åº¦äº‹ä»¶ï¼ˆçµ¦ Web å‰ç«¯ç”¨ï¼‰"""
    def generate():
        pubsub = r.pubsub()
        pubsub.subscribe(f"progress:{student_id}")
        for message in pubsub.listen():
            if message['type'] == 'message':
                yield f"data: {message['data'].decode()}\n\n"

    return Response(generate(), mimetype='text/event-stream')
```

### 1.5 é˜²æ´—ç‰ˆç­–ç•¥

é¿å…çŸ­æ™‚é–“å…§å¤§é‡è¨Šæ¯è½Ÿç‚¸ç”¨æˆ¶ï¼š

| ç­–ç•¥ | åšæ³• |
|------|------|
| åˆä½µçŸ­æ­¥é©Ÿ | æ­¥é©Ÿ <2 ç§’å®Œæˆçš„ï¼Œåˆä½µåˆ°ä¸‹ä¸€æ¢è¨Šæ¯ |
| ç·¨è¼¯æ›¿ä»£ç™¼é€ | ä½¿ç”¨ TG `edit_message` æ›´æ–°åŒä¸€æ¢è¨Šæ¯ |
| æ€è€ƒæ‘˜è¦ | LLM çš„ thinking åªå–å‰ 50 å­— |
| ç¯€æµ | åŒä¸€ç”¨æˆ¶æ¯ 3 ç§’æœ€å¤š 1 æ¢é€²åº¦è¨Šæ¯ |

---

## äºŒã€å›é¥‹è¿­ä»£æ©Ÿåˆ¶ï¼ˆFeedback Loopï¼‰

### 2.1 è¨­è¨ˆæ¦‚å¿µ

```
ç”¨æˆ¶ä½¿ç”¨ Agent â†’ ç”¢å‡ºæˆæœ â†’ ç”¨æˆ¶è¦æ±‚èª¿æ•´
    â†“                              â†“
  è¨˜éŒ„ execution_log          è¨˜éŒ„ adjustment_request
    â†“                              â†“
    â””â”€â”€â”€â”€â”€â”€â”€â”€ åˆä½µ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
        Feedback Recordï¼ˆå›é¥‹è¨˜éŒ„ï¼‰
                â†“
        ç´¯ç©åˆ° feedback_store
                â†“
        å¾Œå°ç®¡ç†è€…æª¢è¦–
                â†“
    æ±ºå®šæ˜¯å¦è¿­ä»£ MODULE.yaml / SKILL.md
```

### 2.2 å›é¥‹è¨˜éŒ„çµæ§‹

```yaml
# feedback_record.yaml
feedback_id: "fb-20260129-001"
timestamp: "2026-01-29T14:30:00+08:00"
student_id: "user_12345"

# åŸå§‹åŸ·è¡Œ
execution:
  execution_id: "exec-abc123"
  agent_id: "M2"
  agent_name: "ç¶²ç«™ç”Ÿæˆèˆ‡éƒ¨ç½²"
  user_request: "å¹«æˆ‘å»ºä¸€å€‹å€‹äººä½œå“é›†ç¶²ç«™"
  outputs:
    github_repo: "https://github.com/..."
    deploy_url: "https://xxx.pages.dev"
  quality_score: 0.95

# ç”¨æˆ¶èª¿æ•´è«‹æ±‚ï¼ˆå¯å¤šæ¬¡ï¼‰
adjustments:
  - seq: 1
    timestamp: "2026-01-29T14:35:00+08:00"
    user_request: "é¡è‰²å¤ªå–®èª¿äº†ï¼Œæˆ‘è¦æš—è‰²ä¸»é¡Œ"
    category: "style"         # åˆ†é¡ï¼šstyle / feature / spec / bug
    resolved: true
    resolution_summary: "å·²åˆ‡æ›ç‚ºæš—è‰²ä¸»é¡Œé…è‰²"

  - seq: 2
    timestamp: "2026-01-29T14:40:00+08:00"
    user_request: "åŠ ä¸€å€‹è¯çµ¡è¡¨å–®"
    category: "feature"
    resolved: true
    resolution_summary: "æ–°å¢ Contact é é¢å«è¡¨å–®"

# èƒå–çš„æ–°åƒæ•¸ï¼ˆç³»çµ±è‡ªå‹•èƒå– + äººå·¥æ¨™è¨»ï¼‰
extracted_params:
  - param_name: "theme"
    param_value: "dark"
    source: "adjustment_1"
    applicable_to: ["M2"]
    suggested_default: false    # æ˜¯å¦å»ºè­°æ”¹ç‚ºé è¨­å€¼

  - param_name: "include_contact_form"
    param_value: true
    source: "adjustment_2"
    applicable_to: ["M2"]
    suggested_default: true     # é«˜é »éœ€æ±‚ï¼Œå»ºè­°ç´å…¥é è¨­

# çµ±è¨ˆ
stats:
  total_adjustments: 2
  categories: {style: 1, feature: 1}
  satisfaction: null            # ç”¨æˆ¶æ»¿æ„åº¦ï¼ˆå¯é¸ï¼‰
```

### 2.3 å›é¥‹æ”¶é›†æµç¨‹

#### è‡ªå‹•æ”¶é›†

```python
# feedback_collector.py

class FeedbackCollector:
    """
    å›é¥‹æ”¶é›†å™¨

    è‡ªå‹•è¨˜éŒ„æ¯æ¬¡ execution å’Œå¾ŒçºŒçš„ adjustmentï¼Œ
    èƒå–å¯èƒ½çš„æ–°åƒæ•¸ä¾›ç®¡ç†è€…æ±ºç­–ã€‚
    """

    def __init__(self, store_dir: str, redis_client=None):
        self.store_dir = Path(store_dir)
        self.store_dir.mkdir(parents=True, exist_ok=True)
        self.redis = redis_client

    def record_execution(self, execution) -> str:
        """è¨˜éŒ„åˆæ¬¡åŸ·è¡Œ"""
        feedback_id = f"fb-{datetime.now().strftime('%Y%m%d')}-{execution.execution_id}"

        record = {
            'feedback_id': feedback_id,
            'timestamp': datetime.now().isoformat(),
            'student_id': execution.student_id,
            'execution': {
                'execution_id': execution.execution_id,
                'agent_id': execution.agent.id,
                'agent_name': execution.agent.name,
                'user_request': execution.user_request,
                'outputs': execution.outputs,
                'quality_score': execution.quality_score,
                'step_results': {
                    k: {'state': v.state.value, 'duration_ms': v.duration_ms}
                    for k, v in execution.step_results.items()
                }
            },
            'adjustments': [],
            'extracted_params': [],
            'stats': {'total_adjustments': 0, 'categories': {}}
        }

        self._save(feedback_id, record)

        # åœ¨ Redis ä¸­å»ºç«‹ student â†’ feedback çš„å°æ‡‰
        if self.redis:
            self.redis.set(
                f"active_feedback:{execution.student_id}",
                feedback_id, ex=3600
            )

        return feedback_id

    def record_adjustment(self, student_id: str, user_request: str,
                         category: str = 'unknown', resolution: str = ''):
        """è¨˜éŒ„ç”¨æˆ¶èª¿æ•´è«‹æ±‚"""
        feedback_id = self._get_active_feedback(student_id)
        if not feedback_id:
            return None

        record = self._load(feedback_id)

        seq = len(record['adjustments']) + 1
        adjustment = {
            'seq': seq,
            'timestamp': datetime.now().isoformat(),
            'user_request': user_request,
            'category': category,
            'resolved': bool(resolution),
            'resolution_summary': resolution
        }

        record['adjustments'].append(adjustment)
        record['stats']['total_adjustments'] = seq
        record['stats']['categories'][category] = \
            record['stats']['categories'].get(category, 0) + 1

        # å˜—è©¦è‡ªå‹•èƒå–åƒæ•¸
        extracted = self._extract_params(adjustment, record)
        if extracted:
            record['extracted_params'].extend(extracted)

        self._save(feedback_id, record)
        return feedback_id

    def _extract_params(self, adjustment, record):
        """
        å¾èª¿æ•´è«‹æ±‚ä¸­èƒå–å¯èƒ½çš„æ–°åƒæ•¸

        è¦å‰‡å¼èƒå–ï¼ˆMVPï¼‰ï¼Œå¾ŒçºŒå¯ç”¨ LLM å¼·åŒ–
        """
        params = []
        req = adjustment['user_request'].lower()
        agent_id = record['execution']['agent_id']

        # é¢¨æ ¼ç›¸é—œ
        style_keywords = {
            'æš—è‰²': ('theme', 'dark'),
            'æ·±è‰²': ('theme', 'dark'),
            'dark': ('theme', 'dark'),
            'äº®è‰²': ('theme', 'light'),
            'ç°¡ç´„': ('style', 'minimal'),
            'ç¾ä»£': ('style', 'modern'),
        }
        for keyword, (name, value) in style_keywords.items():
            if keyword in req:
                params.append({
                    'param_name': name,
                    'param_value': value,
                    'source': f"adjustment_{adjustment['seq']}",
                    'applicable_to': [agent_id],
                    'suggested_default': False
                })

        # åŠŸèƒ½ç›¸é—œ
        feature_keywords = {
            'è¡¨å–®': ('include_form', True),
            'è¯çµ¡': ('include_contact', True),
            'æœå°‹': ('include_search', True),
            'ç™»å…¥': ('include_auth', True),
            'rwd': ('responsive', True),
            'éŸ¿æ‡‰å¼': ('responsive', True),
        }
        for keyword, (name, value) in feature_keywords.items():
            if keyword in req:
                params.append({
                    'param_name': name,
                    'param_value': value,
                    'source': f"adjustment_{adjustment['seq']}",
                    'applicable_to': [agent_id],
                    'suggested_default': False
                })

        return params

    def get_feedback(self, feedback_id):
        return self._load(feedback_id)

    def list_feedbacks(self, agent_id=None, limit=50):
        """åˆ—å‡ºå›é¥‹è¨˜éŒ„"""
        feedbacks = []
        for f in sorted(self.store_dir.glob('*.json'), reverse=True)[:limit]:
            record = json.loads(f.read_text())
            if agent_id and record['execution']['agent_id'] != agent_id:
                continue
            feedbacks.append({
                'feedback_id': record['feedback_id'],
                'agent_id': record['execution']['agent_id'],
                'student_id': record['student_id'],
                'adjustments': record['stats']['total_adjustments'],
                'categories': record['stats']['categories'],
                'extracted_params': len(record['extracted_params']),
                'timestamp': record['timestamp']
            })
        return feedbacks

    def get_param_stats(self, agent_id: str):
        """
        çµ±è¨ˆæŸå€‹ Agent çš„åƒæ•¸å‡ºç¾é »ç‡

        ç”¨æ–¼å¾Œå°ç®¡ç†è€…åˆ¤æ–·æ˜¯å¦è¦å°‡åƒæ•¸ç´å…¥ MODULE.yaml é è¨­
        """
        param_counts = {}

        for f in self.store_dir.glob('*.json'):
            record = json.loads(f.read_text())
            if record['execution']['agent_id'] != agent_id:
                continue
            for p in record['extracted_params']:
                key = f"{p['param_name']}={p['param_value']}"
                param_counts[key] = param_counts.get(key, 0) + 1

        # æŒ‰å‡ºç¾æ¬¡æ•¸æ’åº
        sorted_params = sorted(param_counts.items(), key=lambda x: -x[1])
        return [
            {'param': k, 'count': v, 'suggest_default': v >= 3}
            for k, v in sorted_params
        ]

    def _get_active_feedback(self, student_id):
        if self.redis:
            fb_id = self.redis.get(f"active_feedback:{student_id}")
            return fb_id.decode() if fb_id else None
        return None

    def _save(self, feedback_id, record):
        path = self.store_dir / f"{feedback_id}.json"
        path.write_text(json.dumps(record, ensure_ascii=False, indent=2))

    def _load(self, feedback_id):
        path = self.store_dir / f"{feedback_id}.json"
        if path.exists():
            return json.loads(path.read_text())
        return None
```

### 2.4 å¾Œå°ç®¡ç† API

```python
# å›é¥‹ç®¡ç†ç«¯é»ï¼ˆåƒ…é™ç®¡ç†è€…ï¼‰

@app.route('/api/v1/admin/feedbacks', methods=['GET'])
def admin_list_feedbacks():
    """åˆ—å‡ºæ‰€æœ‰å›é¥‹è¨˜éŒ„"""
    agent_id = request.args.get('agent_id')
    return jsonify(feedback_collector.list_feedbacks(agent_id))

@app.route('/api/v1/admin/feedbacks/<feedback_id>', methods=['GET'])
def admin_get_feedback(feedback_id):
    """å–å¾—å›é¥‹è©³æƒ…"""
    return jsonify(feedback_collector.get_feedback(feedback_id))

@app.route('/api/v1/admin/agents/<agent_id>/param-stats', methods=['GET'])
def admin_param_stats(agent_id):
    """
    æŸ¥çœ‹æŸ Agent çš„åƒæ•¸çµ±è¨ˆ

    å›å‚³ç¯„ä¾‹ï¼š
    [
        {"param": "theme=dark", "count": 15, "suggest_default": true},
        {"param": "include_contact=True", "count": 8, "suggest_default": true},
        {"param": "style=minimal", "count": 2, "suggest_default": false}
    ]
    """
    return jsonify(feedback_collector.get_param_stats(agent_id))

@app.route('/api/v1/admin/agents/<agent_id>/apply-param', methods=['POST'])
def admin_apply_param(agent_id):
    """
    ç®¡ç†è€…æ±ºå®šå°‡æŸåƒæ•¸ç´å…¥ MODULE.yaml é è¨­

    POST Body:
    {
        "param_name": "theme",
        "default_value": "dark",
        "add_to_inputs": true
    }
    """
    data = request.json
    # æ›´æ–° MODULE.yaml
    # è¨˜éŒ„è®Šæ›´æ­·å²
    # é‡è¼‰ Agent Registry
    pass
```

### 2.5 å›é¥‹é–‰ç’°æµç¨‹

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚         å¾Œå°ç®¡ç†ä»‹é¢              â”‚
                    â”‚                                  â”‚
                    â”‚  ğŸ“Š åƒæ•¸çµ±è¨ˆï¼š                    â”‚
                    â”‚   theme=dark      å‡ºç¾ 15 æ¬¡ â¬†ï¸  â”‚
                    â”‚   include_form    å‡ºç¾ 8 æ¬¡  â¬†ï¸  â”‚
                    â”‚   style=minimal   å‡ºç¾ 2 æ¬¡      â”‚
                    â”‚                                  â”‚
                    â”‚  [âœ… ç´å…¥é è¨­] [âŒ æš«ä¸] [ğŸ“ å‚™è¨»]â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚ ç®¡ç†è€…æ±ºå®š
                               â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ MODULE.yaml æ›´æ–°     â”‚
                    â”‚                      â”‚
                    â”‚ inputs:              â”‚
                    â”‚   theme:             â”‚
                    â”‚     default: "dark"  â”‚ â† æ–°å¢
                    â”‚   include_form:      â”‚
                    â”‚     default: true    â”‚ â† æ–°å¢
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â†“
                    Agent Registry ç†±é‡è¼‰
                               â”‚
                               â†“
                    ä¸‹æ¬¡åŸ·è¡Œæ™‚è‡ªå‹•å¥—ç”¨æ–°é è¨­
```

### 2.6 èª¿æ•´åˆ†é¡å™¨

ç”¨æˆ¶çš„èª¿æ•´è«‹æ±‚éœ€è¦åˆ†é¡ï¼Œä»¥æ±ºå®šè™•ç†æ–¹å¼ï¼š

| åˆ†é¡ | èªªæ˜ | è™•ç†æ–¹å¼ |
|------|------|---------|
| `style` | è¦–è¦º/é¢¨æ ¼èª¿æ•´ | é‡è·‘ LLM æ­¥é©Ÿï¼Œé™„åŠ é¢¨æ ¼åƒæ•¸ |
| `feature` | æ–°å¢åŠŸèƒ½ | é‡è·‘ coding_agent æ­¥é©Ÿ |
| `spec` | è¦æ ¼/æ¶æ§‹è®Šæ›´ | å¯èƒ½éœ€é‡è·‘æ•´å€‹ Agent |
| `bug` | ç”¢å‡ºæœ‰éŒ¯èª¤ | é‡è·‘ validate + coding_agent |
| `content` | å…§å®¹/æ–‡æ¡ˆèª¿æ•´ | é‡è·‘ LLM ç›¸é—œæ­¥é©Ÿ |

```python
def classify_adjustment(user_request: str) -> str:
    """åˆ†é¡èª¿æ•´è«‹æ±‚ï¼ˆMVP è¦å‰‡å¼ï¼Œå¾ŒçºŒå¯ç”¨ LLMï¼‰"""
    req = user_request.lower()

    style_words = ['é¡è‰²', 'é…è‰²', 'å­—é«”', 'æ’ç‰ˆ', 'ä¸»é¡Œ', 'theme', 'css', 'é¢¨æ ¼']
    feature_words = ['åŠ ', 'æ–°å¢', 'å¢åŠ ', 'åŠŸèƒ½', 'åŠ å…¥', 'æ·»åŠ ']
    bug_words = ['éŒ¯', 'å£', 'bug', 'ä¸èƒ½', 'å¤±æ•—', 'ä¿®']
    content_words = ['æ–‡å­—', 'æ¨™é¡Œ', 'å…§å®¹', 'æè¿°', 'æ–‡æ¡ˆ']

    if any(w in req for w in bug_words):
        return 'bug'
    if any(w in req for w in style_words):
        return 'style'
    if any(w in req for w in feature_words):
        return 'feature'
    if any(w in req for w in content_words):
        return 'content'
    return 'spec'
```

---

## ä¸‰ã€å…©è€…å¦‚ä½•æ•´åˆ

### 3.1 å®Œæ•´è³‡æ–™æµ

```
ç”¨æˆ¶è«‹æ±‚
  â†“
Agent Executor é–‹å§‹
  â†“
ProgressEmitter â”€â”€â†’ Redis Pub/Sub â”€â”€â†’ TG Bot â”€â”€â†’ ç”¨æˆ¶çœ‹åˆ°é€²åº¦
  â†“
åŸ·è¡Œå®Œæˆ
  â†“
FeedbackCollector.record_execution() â”€â”€â†’ feedback_store/
  â†“
ç”¨æˆ¶å›è¦†ã€Œæ”¹ä¸€ä¸‹ XXXã€
  â†“
classify_adjustment() â†’ åˆ†é¡
  â†“
FeedbackCollector.record_adjustment() â†’ è¨˜éŒ„ + èƒå–åƒæ•¸
  â†“
Agent Executor é‡è·‘ç›¸é—œæ­¥é©Ÿ
  â†“
ProgressEmitter â”€â”€â†’ ç”¨æˆ¶çœ‹åˆ°ä¿®æ”¹é€²åº¦
  â†“
ç´¯ç©å¤šç­† feedback
  â†“
ç®¡ç†è€…æŸ¥çœ‹ /admin/agents/M2/param-stats
  â†“
æ±ºå®šæ˜¯å¦æ›´æ–° MODULE.yaml é è¨­
```

### 3.2 éœ€è¦æ–°å¢/ä¿®æ”¹çš„æª”æ¡ˆ

| æª”æ¡ˆ | é¡å‹ | èªªæ˜ |
|------|------|------|
| `progress_emitter.py` | æ–°å¢ | é€²åº¦äº‹ä»¶ç™¼å°„å™¨ |
| `feedback_collector.py` | æ–°å¢ | å›é¥‹æ”¶é›†èˆ‡åƒæ•¸èƒå– |
| `tg_progress_listener.py` | æ–°å¢ | TG Bot é€²åº¦è¨‚é–±ç«¯ |
| `agent_executor.py` | ä¿®æ”¹ | æ³¨å…¥ ProgressEmitter |
| `proxy.py` | ä¿®æ”¹ | æ–°å¢å›é¥‹ API + é€²åº¦ SSE ç«¯é» |
| `feedback_store/` | æ–°å¢ç›®éŒ„ | å›é¥‹è¨˜éŒ„ JSON å„²å­˜ |

### 3.3 èˆ‡ v3 Ingress Pipeline çš„å°æ‡‰

| v3 Ingress æ­¥é©Ÿ | é€²åº¦/å›é¥‹ æ•´åˆé» |
|-----------------|-----------------|
| Step 7: Planner Decision | â†’ emit `task_started` |
| Step 9: Execution | â†’ emit `step_started` / `step_completed` |
| Step 10: Audit & Reply | â†’ `record_execution()` + å®Œæˆè¨Šæ¯ |
| ç”¨æˆ¶å¾ŒçºŒè¨Šæ¯ | â†’ `record_adjustment()` + é‡è·‘ |

---

## å››ã€å¯¦ä½œå„ªå…ˆç´š

| å„ªå…ˆç´š | é …ç›® | è¤‡é›œåº¦ |
|--------|------|--------|
| P0 | ProgressEmitter + TG æ¨é€ | ä¸­ |
| P0 | Agent Executor æ³¨å…¥ emitter | ä½ |
| P1 | FeedbackCollector æ ¸å¿ƒ | ä¸­ |
| P1 | èª¿æ•´åˆ†é¡å™¨ï¼ˆè¦å‰‡å¼ï¼‰ | ä½ |
| P2 | å¾Œå°ç®¡ç† API | ä¸­ |
| P2 | é˜²æ´—ç‰ˆç­–ç•¥ï¼ˆedit_messageï¼‰ | ä½ |
| P3 | LLM å¢å¼·åˆ†é¡/èƒå– | é«˜ |
| P3 | MODULE.yaml è‡ªå‹•æ›´æ–° | ä¸­ |

## åŸæ–‡è³‡è¨Š
- ä¾†æºï¼šè¨­è¨ˆè¨è«–
- æ™‚é–“ï¼š2026-01-29
- ç›¸é—œå°ˆæ¡ˆï¼šSuper Happy Coder (acmacmini2:~/workshop/super-happy-coder/)
