---
title: 3090 Compute Plane 部署與網路連通紀錄
date: 2026-01-29
category: tech
tags: [3090, compute-plane, ssh-tunnel, tailscale, networking, super-happy-coder]
source: 工作日誌
---

# 3090 Compute Plane 部署與網路連通紀錄

## 摘要

在 3090 主機 (ac-3090) 上完成 Compute Plane API 部署，包含 LLM (vLLM)、Embedding、
Rerank、OCR、Toolchain 五大服務。因 Tailscale ACL 限制，改用 SSH Tunnel 實現
Mac Mini 2 到 3090 的 port 9000 連通。

---

## 一、3090 已安裝元件

### Phase 1：基礎環境
- FastAPI 0.128.0 + Uvicorn 0.40.0
- Redis Server 6.0.16（systemd 自啟）
- poppler-utils、ImageMagick
- httpx、pydantic、pyyaml

### Phase 2：Embedding + Rerank
- sentence-transformers 5.2.2
- transformers 4.57.6（被 vLLM 降級至此版本）
- faiss-gpu 1.7.2
- 預設 Embedding 模型：BAAI/bge-base-zh-v1.5（768 維，已下載）
- 預設 Rerank 模型：BAAI/bge-reranker-v2-m3（待首次呼叫時下載）

### Phase 3：OCR
- paddlepaddle-gpu 2.6.2
- paddleocr 3.3.3
- 預設語言：ch（中文）

### Phase 4：LLM 推理引擎
- vLLM 0.14.1
- torch 2.9.1 + CUDA 12.x
- **注意**：vLLM server 需另外啟動並載入模型（見下方說明）

### Phase 5：Toolchain
- Node.js 20.20.0 + npm 10.8.2
- ruff 0.14.14、mypy 1.19.1、pytest 9.0.2

---

## 二、Compute Plane API 服務

### 服務位置
- **程式碼**：`ac-3090:/home/ac3090/compute-plane/main.py`
- **systemd**：`compute-plane.service`
- **端口**：9000
- **API Key**：`shc-compute-2026`（Bearer Token）

### API 端點
```
GET  /health                    # 健康檢查（不需認證）
POST /v1/llm/generate           # LLM 生成（轉發到 vLLM）
POST /v1/llm/tool-call          # LLM 工具呼叫（轉發到 vLLM）
POST /v1/embeddings             # 文字向量化
POST /v1/rerank                 # 文件重排序
POST /v1/ocr/submit             # OCR 提交（非同步）
GET  /v1/ocr/result/{job_id}    # OCR 結果查詢
POST /v1/tools/run              # 工具執行（白名單限制）
GET  /v1/gpu/status             # GPU 詳細狀態
```

### 管理指令
```bash
# 查看狀態
sudo systemctl status compute-plane

# 重啟
sudo systemctl restart compute-plane

# 查看日誌
journalctl -u compute-plane -f

# 手動啟動（除錯用）
cd /home/ac3090/compute-plane
python3 -m uvicorn main:app --host 0.0.0.0 --port 9000
```

### 模型延遲載入
- Embedding / Rerank / OCR 模型在首次 API 呼叫時自動載入
- 首次呼叫會比較慢（下載 + 載入到 GPU）
- 後續呼叫使用快取的模型實例

---

## 三、網路連通方案

### 問題描述
Mac Mini 2 (acmacmini2, 100.118.162.26) 無法直連 3090 (ac-3090, 100.108.119.78) 的
port 9000，原因：

1. **Tailscale ACL 限制**：原始設計是防止 Mac Mini 2 橫向移動（因上面有 Clawdbot）
2. **iptables ts-input chain**：3090 的 Tailscale 自動生成 `DROP 100.64.0.0/10` 規則，
   攔截所有 Tailscale CGNAT 流量
3. **ACL 修改無效**：即使在 Tailscale Admin Console 修改 ACL 開放 port 9000，
   3090 的 iptables 規則不會同步更新（Tailscale daemon 重啟後會覆蓋手動修改）

### 嘗試過的方案（失敗）
- 修改 Tailscale ACL 開放 `acmacmini2 → ac-3090:9000` — iptables 不同步
- 手動 `iptables -I ts-input` — Tailscale 重啟後被覆蓋
- 重啟 3090 Tailscale daemon — 規則不變

### 最終方案：SSH Tunnel（成功）

**原理**：SSH (port 22) 是通的，透過 SSH 隧道轉發 port 9000

**服務檔**：`/etc/systemd/system/ssh-tunnel-3090.service`（在 Mac Mini 2 上）

```ini
[Unit]
Description=SSH Tunnel to 3090 Compute Plane (port 9000)
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
User=ac-mac
ExecStart=/usr/bin/ssh -N -L 9000:localhost:9000 -o ServerAliveInterval=30 -o ServerAliveCountMax=3 -o ExitOnForwardFailure=yes -o StrictHostKeyChecking=no ac-3090
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

**管理指令**（在 Mac Mini 2 上執行）：
```bash
# 查看狀態
sudo systemctl status ssh-tunnel-3090

# 重啟
sudo systemctl restart ssh-tunnel-3090

# 停止
sudo systemctl stop ssh-tunnel-3090
```

**使用方式**：
```bash
# 從 Mac Mini 2 呼叫 3090 Compute Plane
curl http://localhost:9000/health
curl -X POST http://localhost:9000/v1/embeddings \
  -H "Authorization: Bearer shc-compute-2026" \
  -H "Content-Type: application/json" \
  -d '{"texts": ["你好世界"]}'
```

---

## 四、Tailscale 裝置一覽

| 裝置名稱 | Tailscale IP | 用途 |
|----------|-------------|------|
| acmac-macmini | 100.116.154.40 | Mac Mini (原始) |
| **acmacmini2** | **100.118.162.26** | **Mac Mini 2（Super Happy Coder）** |
| **ac-3090** | **100.108.119.78** | **3090 GPU（Compute Plane）** |
| ac-4090 | 100.109.200.56 | 4090（另一帳號） |
| ac-rpi5 | 100.71.216.27 | RPI5 |
| usermacbook-pro-2 | 100.108.157.80 | MacBook Pro |
| xiaomi | 100.123.114.23 | 手機 |

### Tailscale ACL 目前設定
- acmacmini2 → ac-3090: port 22 已開放
- acmacmini2 → ac-3090: port 9000, 8188, 3003 已在 ACL 設定但 iptables 未同步

### SSH Config（Mac Mini 2: ~/.ssh/config）
```
Host ac-3090
  HostName 100.108.119.78
  User ac3090
  IdentityFile ~/.ssh/id_ed25519
  StrictHostKeyChecking no
  ConnectTimeout 5
```

---

## 五、ComfyUI 備註

- ComfyUI 已暫停（PID 12556 已 kill）以釋放 VRAM
- 原佔用約 7GB VRAM
- 路徑：`/home/ac3090/ComfyUI/`
- 啟動指令：`cd ~/ComfyUI && venv/bin/python main.py --listen 100.108.119.78 --port 8188`
- 若需重啟 ComfyUI，注意 VRAM 可能與 Compute Plane 模型衝突

---

## 六、待辦事項

- [ ] 選擇並下載 LLM 模型（Qwen2.5-7B 或其他），啟動 vLLM server
- [ ] 將 Compute Plane API 整合到 Super Happy Coder proxy.py 的 Agent Executor
- [ ] TG Bot Token 取得後整合
- [ ] 解決 Tailscale iptables 不同步問題（長期）
