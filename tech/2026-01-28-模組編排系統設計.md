---
title: æ¨¡çµ„ç·¨æ’ç³»çµ±è¨­è¨ˆ - Module Orchestrator
date: 2026-01-28
category: tech
tags: [AI, agent, module, orchestrator, state-machine, æ¶æ§‹è¨­è¨ˆ]
---

# æ¨¡çµ„ç·¨æ’ç³»çµ±è¨­è¨ˆ

åˆ†æ OpenSpec çš„ Module Orchestrator å¦‚ä½•å¼·åŒ– Super Happy Coder çš„ç”¢å‡ºç²¾æº–åº¦èˆ‡ç²¾ç·»åº¦ã€‚

---

## 1. ç¾æœ‰ vs å¢å¼·æ¶æ§‹

### ç¾æœ‰æ¶æ§‹ï¼ˆSimple Skill Matchingï¼‰

```
User Request â†’ Intent Router â†’ Match Skill â†’ Execute CLI â†’ Response
                    â†“
              (å–®æ¬¡åŒ¹é…)
```

**å•é¡Œ**ï¼š
- åªåšä¸€æ¬¡æ€§çš„ Skill åŒ¹é…
- æ²’æœ‰ä»»å‹™åˆ†è§£
- æ²’æœ‰ç‹€æ…‹è¿½è¹¤
- è¤‡é›œä»»å‹™å®¹æ˜“å¤±æ•—æˆ–ä¸å®Œæ•´

### å¢å¼·æ¶æ§‹ï¼ˆModule Orchestratorï¼‰

```
User Request â†’ Intent Router â†’ Module Selection â†’ Planner
                                                     â†“
                                              Task Decomposition
                                                     â†“
                                              State Machine
                                                     â†“
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â–¼                â–¼                â–¼
                              [Step 1]         [Step 2]         [Step N]
                                    â”‚                â”‚                â”‚
                                    â–¼                â–¼                â–¼
                              Tool Exec        Tool Exec        Tool Exec
                                    â”‚                â”‚                â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                     â–¼
                                              Result Aggregation
                                                     â–¼
                                              Quality Check
                                                     â–¼
                                                Response
```

---

## 2. æ ¸å¿ƒçµ„ä»¶

### 2.1 Module Registryï¼ˆæ¨¡çµ„è¨»å†Šè¡¨ï¼‰

```python
@dataclass
class Module:
    """æ¨¡çµ„å®šç¾©"""
    id: str                      # M1, M2, M3...
    name: str                    # é¡¯ç¤ºåç¨±
    description: str             # ç”¨é€”èªªæ˜
    triggers: List[str]          # è§¸ç™¼é—œéµå­—

    # æ¨¡çµ„èƒ½åŠ›
    inputs: List[str]            # éœ€è¦çš„è¼¸å…¥
    outputs: List[str]           # ç”¢å‡ºé¡å‹
    tools: List[str]             # ä½¿ç”¨çš„å·¥å…·

    # åŸ·è¡Œè¨­å®š
    steps: List[StepDefinition]  # åŸ·è¡Œæ­¥é©Ÿ
    timeout: int                 # è¶…æ™‚ç§’æ•¸
    requires_approval: bool      # æ˜¯å¦éœ€è¦è¬›å¸«å¯©æ ¸

    # å“è³ªæª¢æŸ¥
    validators: List[str]        # é©—è­‰å™¨
    quality_criteria: Dict       # å“è³ªæ¨™æº–
```

### 2.2 Task Plannerï¼ˆä»»å‹™è¦åŠƒå™¨ï¼‰

```python
class TaskPlanner:
    """å°‡ç”¨æˆ¶è«‹æ±‚åˆ†è§£ç‚ºå¯åŸ·è¡Œçš„æ­¥é©Ÿ"""

    def plan(self, request: str, module: Module, context: dict) -> TaskPlan:
        """
        ä½¿ç”¨ LLM é€²è¡Œä»»å‹™è¦åŠƒ

        1. åˆ†æè«‹æ±‚æ„åœ–
        2. æ ¹æ“šæ¨¡çµ„å®šç¾©ç”¢ç”Ÿæ­¥é©Ÿ
        3. è­˜åˆ¥ä¾è³´é—œä¿‚
        4. è¨­å®šæª¢æŸ¥é»
        """

        planning_prompt = f"""
        <module-definition>
        {module.to_yaml()}
        </module-definition>

        <user-request>
        {request}
        </user-request>

        <context>
        {context}
        </context>

        è«‹æ ¹æ“šæ¨¡çµ„å®šç¾©ï¼Œå°‡ç”¨æˆ¶è«‹æ±‚åˆ†è§£ç‚ºå…·é«”æ­¥é©Ÿã€‚
        æ¯å€‹æ­¥é©Ÿéœ€è¦åŒ…å«ï¼š
        - step_id: æ­¥é©Ÿç·¨è™Ÿ
        - action: åŸ·è¡Œå‹•ä½œ
        - tool: ä½¿ç”¨å·¥å…·
        - inputs: è¼¸å…¥åƒæ•¸
        - expected_output: é æœŸè¼¸å‡º
        - validation: é©—è­‰æ–¹å¼
        - depends_on: ä¾è³´çš„æ­¥é©Ÿ

        è¼¸å‡º JSON æ ¼å¼ã€‚
        """

        return self._call_planner_llm(planning_prompt)
```

### 2.3 State Machineï¼ˆç‹€æ…‹æ©Ÿï¼‰

```python
class TaskState(Enum):
    PENDING = "pending"
    PLANNING = "planning"
    EXECUTING = "executing"
    VALIDATING = "validating"
    WAITING_APPROVAL = "waiting_approval"
    COMPLETED = "completed"
    FAILED = "failed"
    ROLLBACK = "rollback"

@dataclass
class TaskExecution:
    """ä»»å‹™åŸ·è¡Œç‹€æ…‹"""
    task_id: str
    student_id: str
    module_id: str
    state: TaskState

    plan: TaskPlan
    current_step: int
    step_results: Dict[str, StepResult]

    created_at: datetime
    updated_at: datetime

    # å“è³ªè¿½è¹¤
    quality_score: float
    issues: List[str]

    def advance(self):
        """æ¨é€²åˆ°ä¸‹ä¸€æ­¥"""
        pass

    def rollback(self, to_step: int):
        """å›æ»¾åˆ°æŒ‡å®šæ­¥é©Ÿ"""
        pass
```

### 2.4 Quality Validatorï¼ˆå“è³ªé©—è­‰å™¨ï¼‰

```python
class QualityValidator:
    """é©—è­‰ç”¢å‡ºå“è³ª"""

    validators = {
        'code': CodeValidator(),
        'deploy': DeployValidator(),
        'rag': RAGValidator(),
        'scaffold': ScaffoldValidator(),
    }

    def validate(self, module: Module, outputs: Dict) -> ValidationResult:
        """
        æ ¹æ“šæ¨¡çµ„çš„å“è³ªæ¨™æº–é©—è­‰ç”¢å‡º

        Returns:
            ValidationResult:
                - passed: bool
                - score: float (0-1)
                - issues: List[str]
                - suggestions: List[str]
        """
        pass

class CodeValidator:
    """ç¨‹å¼ç¢¼å“è³ªé©—è­‰"""

    def validate(self, code: str, criteria: Dict) -> ValidationResult:
        checks = []

        # 1. èªæ³•æª¢æŸ¥
        if criteria.get('syntax_check'):
            checks.append(self._check_syntax(code))

        # 2. æ˜¯å¦å¯åŸ·è¡Œ
        if criteria.get('runnable'):
            checks.append(self._check_runnable(code))

        # 3. æ¸¬è©¦è¦†è“‹
        if criteria.get('has_tests'):
            checks.append(self._check_tests(code))

        # 4. æ–‡ä»¶å®Œæ•´
        if criteria.get('documented'):
            checks.append(self._check_docs(code))

        return self._aggregate(checks)
```

---

## 3. æ¨¡çµ„å®šç¾©ç¯„ä¾‹

### M2: ç¶²ç«™ç”Ÿæˆ + éƒ¨ç½²

```yaml
# skills/web-deploy/MODULE.yaml
id: M2
name: ç¶²ç«™ç”Ÿæˆèˆ‡éƒ¨ç½²
description: ç”Ÿæˆç¶²ç«™å°ˆæ¡ˆä¸¦éƒ¨ç½²åˆ° Cloudflare Pages

triggers:
  - éƒ¨ç½²ç¶²ç«™
  - å»ºç«‹ç¶²ç«™
  - deploy
  - ä¸Šç·š

inputs:
  - site_description: ç¶²ç«™æè¿°
  - features: åŠŸèƒ½éœ€æ±‚ï¼ˆé¸å¡«ï¼‰
  - template: æ¨¡æ¿é¡å‹ï¼ˆé¸å¡«ï¼‰

outputs:
  - github_repo: GitHub å„²å­˜åº« URL
  - deploy_url: Cloudflare Pages URL
  - source_code: ç¨‹å¼ç¢¼æª”æ¡ˆ

tools:
  - coding-agent  # ç”Ÿæˆç¨‹å¼ç¢¼
  - github        # å»ºç«‹ repo
  - cloudflare    # éƒ¨ç½²

steps:
  - id: analyze
    name: åˆ†æéœ€æ±‚
    action: llm_analyze
    inputs: [site_description, features]
    output: requirements_doc

  - id: scaffold
    name: ç”Ÿæˆå°ˆæ¡ˆéª¨æ¶
    action: coding_agent
    tool: codex
    inputs: [requirements_doc, template]
    output: project_files
    depends_on: [analyze]

  - id: validate_code
    name: é©—è­‰ç¨‹å¼ç¢¼
    action: validate
    validator: code
    inputs: [project_files]
    output: validation_result
    depends_on: [scaffold]

  - id: create_repo
    name: å»ºç«‹ GitHub Repo
    action: github_create
    inputs: [project_files]
    output: github_repo
    depends_on: [validate_code]

  - id: deploy
    name: éƒ¨ç½²åˆ° Cloudflare
    action: cloudflare_deploy
    inputs: [github_repo]
    output: deploy_url
    depends_on: [create_repo]

  - id: verify
    name: é©—è­‰éƒ¨ç½²
    action: http_check
    inputs: [deploy_url]
    output: deploy_status
    depends_on: [deploy]

quality_criteria:
  code:
    syntax_check: true
    runnable: true
    has_readme: true
  deploy:
    accessible: true
    response_time_ms: 3000

timeout: 300
requires_approval: false
```

### M5: ERP Scaffold ç”¢ç”Ÿ

```yaml
# skills/erp-scaffold/MODULE.yaml
id: M5
name: ERP æ¨¡çµ„éª¨æ¶ç”¢ç”Ÿ
description: æ ¹æ“šéœ€æ±‚ç”Ÿæˆ FastAPI + DB çš„ ERP æ¨¡çµ„éª¨æ¶

triggers:
  - ERP
  - ç”¢ç”Ÿæ¨¡çµ„
  - scaffold
  - FastAPI
  - è³‡æ–™åº«

inputs:
  - module_name: æ¨¡çµ„åç¨±
  - entities: è³‡æ–™å¯¦é«”æè¿°
  - business_rules: æ¥­å‹™è¦å‰‡ï¼ˆé¸å¡«ï¼‰

outputs:
  - db_schema: è³‡æ–™åº« Schema
  - api_code: FastAPI ç¨‹å¼ç¢¼
  - test_code: æ¸¬è©¦ç¨‹å¼ç¢¼
  - docker_compose: Docker è¨­å®š

steps:
  - id: analyze_entities
    name: åˆ†æè³‡æ–™å¯¦é«”
    action: llm_analyze
    inputs: [module_name, entities]
    output: entity_model

  - id: design_schema
    name: è¨­è¨ˆè³‡æ–™åº« Schema
    action: coding_agent
    prompt_template: |
      æ ¹æ“šä»¥ä¸‹å¯¦é«”æ¨¡å‹ï¼Œè¨­è¨ˆ SQLAlchemy ORM æ¨¡å‹ï¼š
      {entity_model}

      è¦æ±‚ï¼š
      - ä½¿ç”¨ PostgreSQL
      - åŒ…å« created_at, updated_at
      - è¨­è¨ˆé©ç•¶çš„ç´¢å¼•
      - åŠ å…¥ Alembic migration
    output: db_schema
    depends_on: [analyze_entities]

  - id: generate_api
    name: ç”Ÿæˆ API ç¨‹å¼ç¢¼
    action: coding_agent
    prompt_template: |
      æ ¹æ“šä»¥ä¸‹ Schemaï¼Œç”Ÿæˆ FastAPI CRUD APIï¼š
      {db_schema}

      è¦æ±‚ï¼š
      - RESTful è¨­è¨ˆ
      - Pydantic é©—è­‰
      - åˆ†é æŸ¥è©¢
      - éŒ¯èª¤è™•ç†
    output: api_code
    depends_on: [design_schema]

  - id: generate_tests
    name: ç”Ÿæˆæ¸¬è©¦
    action: coding_agent
    prompt_template: |
      ç‚ºä»¥ä¸‹ API ç”Ÿæˆ pytest æ¸¬è©¦ï¼š
      {api_code}

      è¦æ±‚ï¼š
      - è¦†è“‹ CRUD æ“ä½œ
      - ä½¿ç”¨ fixtures
      - æ¸¬è©¦éŒ¯èª¤æƒ…æ³
    output: test_code
    depends_on: [generate_api]

  - id: validate_all
    name: é©—è­‰æ‰€æœ‰ç”¢å‡º
    action: validate
    validator: scaffold
    inputs: [db_schema, api_code, test_code]
    output: validation_result
    depends_on: [generate_tests]

  - id: run_tests
    name: åŸ·è¡Œæ¸¬è©¦
    action: shell
    command: "cd {workspace} && docker-compose up -d && pytest"
    inputs: [validation_result]
    output: test_result
    depends_on: [validate_all]

quality_criteria:
  code:
    syntax_check: true
    runnable: true
    has_tests: true
    test_coverage: 0.7
  scaffold:
    has_migration: true
    has_docker: true
    api_documented: true

timeout: 600
requires_approval: true  # ERP æ¨¡çµ„éœ€è¦è¬›å¸«å¯©æ ¸
```

---

## 4. åŸ·è¡Œæµç¨‹

### 4.1 å®Œæ•´æµç¨‹åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         User Request                                 â”‚
â”‚                    ã€Œå¹«æˆ‘å»ºä¸€å€‹ Todo ç¶²ç«™ã€                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Intent Classification                           â”‚
â”‚                    â†’ è­˜åˆ¥ç‚ºã€Œç¶²ç«™ç”Ÿæˆã€æ„åœ–                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Module Selection                                â”‚
â”‚                    â†’ é¸æ“‡ M2ï¼ˆç¶²ç«™ç”Ÿæˆ+éƒ¨ç½²ï¼‰                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Task Planner (LLM)                              â”‚
â”‚                                                                      â”‚
â”‚  æ ¹æ“š M2 çš„ steps å®šç¾© + ç”¨æˆ¶éœ€æ±‚ï¼Œç”¢ç”Ÿå…·é«”åŸ·è¡Œè¨ˆåŠƒï¼š                  â”‚
â”‚                                                                      â”‚
â”‚  Step 1: åˆ†æéœ€æ±‚ â†’ ç”¢å‡º requirements.md                             â”‚
â”‚  Step 2: ç”Ÿæˆ React + Tailwind å°ˆæ¡ˆ                                  â”‚
â”‚  Step 3: é©—è­‰ç¨‹å¼ç¢¼èªæ³•                                              â”‚
â”‚  Step 4: å»ºç«‹ GitHub Repo                                            â”‚
â”‚  Step 5: éƒ¨ç½²åˆ° Cloudflare                                           â”‚
â”‚  Step 6: é©—è­‰ç¶²ç«™å¯å­˜å–                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      State Machine Execution                         â”‚
â”‚                                                                      â”‚
â”‚  [pending] â†’ [planning] â†’ [executing] â†’ ...                         â”‚
â”‚                               â”‚                                      â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚                    â–¼          â–¼          â–¼                          â”‚
â”‚                 Step 1     Step 2     Step 3    ...                 â”‚
â”‚                    â”‚          â”‚          â”‚                          â”‚
â”‚                    â–¼          â–¼          â–¼                          â”‚
â”‚                 Result 1   Result 2   Result 3                      â”‚
â”‚                    â”‚          â”‚          â”‚                          â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                               â–¼                                      â”‚
â”‚                         Aggregation                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Quality Validation                              â”‚
â”‚                                                                      â”‚
â”‚  âœ“ èªæ³•æª¢æŸ¥é€šé                                                      â”‚
â”‚  âœ“ ç¶²ç«™å¯å­˜å–                                                        â”‚
â”‚  âœ“ å›æ‡‰æ™‚é–“ < 3000ms                                                 â”‚
â”‚  âš  å»ºè­°ï¼šåŠ å…¥ README.md                                              â”‚
â”‚                                                                      â”‚
â”‚  Quality Score: 0.85                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Response to User                                â”‚
â”‚                                                                      â”‚
â”‚  âœ… Todo ç¶²ç«™å·²å®Œæˆï¼                                                 â”‚
â”‚                                                                      â”‚
â”‚  ğŸ“¦ GitHub: https://github.com/student/todo-app                     â”‚
â”‚  ğŸŒ ç¶²ç«™: https://todo-app.pages.dev                                â”‚
â”‚                                                                      â”‚
â”‚  å“è³ªè©•åˆ†: 85/100                                                    â”‚
â”‚  å»ºè­°ï¼šå¯ä»¥åŠ å…¥ README.md èªªæ˜ä½¿ç”¨æ–¹å¼                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 éŒ¯èª¤è™•ç†èˆ‡å›æ»¾

```python
class Orchestrator:
    async def execute_with_recovery(self, task: TaskExecution):
        """å¸¶æœ‰éŒ¯èª¤æ¢å¾©çš„åŸ·è¡Œ"""

        max_retries = 3

        for step in task.plan.steps:
            for attempt in range(max_retries):
                try:
                    result = await self.execute_step(step)

                    if not result.success:
                        # å˜—è©¦ä¿®å¾©
                        fixed = await self.attempt_fix(step, result)
                        if fixed:
                            result = fixed
                        else:
                            raise StepFailure(step, result)

                    task.step_results[step.id] = result
                    task.advance()
                    break

                except StepFailure as e:
                    if attempt < max_retries - 1:
                        # é‡è©¦å‰ç­‰å¾…
                        await asyncio.sleep(2 ** attempt)
                        continue
                    else:
                        # å›æ»¾åˆ°ä¸Šä¸€å€‹æª¢æŸ¥é»
                        checkpoint = self.find_checkpoint(task, step)
                        await self.rollback(task, checkpoint)

                        # é€šçŸ¥ç”¨æˆ¶
                        await self.notify_failure(task, step, e)
                        return

        # æ‰€æœ‰æ­¥é©Ÿå®Œæˆï¼Œé€²è¡Œæœ€çµ‚é©—è­‰
        await self.final_validation(task)
```

---

## 5. ç²¾æº–åº¦èˆ‡ç²¾ç·»åº¦æå‡

### 5.1 ç²¾æº–åº¦æå‡

| æ©Ÿåˆ¶ | ä½œç”¨ |
|------|------|
| **Task Planner** | å°‡æ¨¡ç³Šéœ€æ±‚åˆ†è§£ç‚ºå…·é«”æ­¥é©Ÿ |
| **Step Validation** | æ¯æ­¥é©Ÿéƒ½æœ‰é æœŸè¼¸å‡ºé©—è­‰ |
| **Quality Criteria** | æ˜ç¢ºçš„å“è³ªæ¨™æº– |
| **Retry & Fix** | å¤±æ•—æ™‚è‡ªå‹•å˜—è©¦ä¿®å¾© |

### 5.2 ç²¾ç·»åº¦æå‡

| æ©Ÿåˆ¶ | ä½œç”¨ |
|------|------|
| **Module Definition** | å®šç¾©å®Œæ•´çš„è¼¸å…¥/è¼¸å‡ºè¦æ ¼ |
| **Prompt Templates** | é‡å°æ¯å€‹æ­¥é©Ÿå„ªåŒ–çš„ prompt |
| **Quality Validators** | æª¢æŸ¥ç¨‹å¼ç¢¼å“è³ªã€æ¸¬è©¦è¦†è“‹ |
| **Suggestions** | æä¾›æ”¹é€²å»ºè­° |

### 5.3 å°æ¯”

| æŒ‡æ¨™ | ç°¡å–® Skill | Module Orchestrator |
|------|-----------|---------------------|
| ä»»å‹™ç†è§£ | é—œéµå­—åŒ¹é… | LLM æ„åœ–åˆ†æ + Planner |
| åŸ·è¡Œæ–¹å¼ | ä¸€æ¬¡æ€§å‘¼å« CLI | å¤šæ­¥é©Ÿç‹€æ…‹æ©Ÿ |
| éŒ¯èª¤è™•ç† | ç›´æ¥å¤±æ•— | é‡è©¦ + å›æ»¾ + ä¿®å¾© |
| å“è³ªä¿è­‰ | ç„¡ | å¤šå±¤é©—è­‰å™¨ |
| ç”¢å‡ºå®Œæ•´æ€§ | å¯èƒ½ä¸å®Œæ•´ | çµæ§‹åŒ–è¼¸å‡º + é©—è­‰ |
| å¯è¿½è¹¤æ€§ | åªæœ‰æœ€çµ‚çµæœ | æ¯æ­¥é©Ÿéƒ½æœ‰è¨˜éŒ„ |

---

## 6. å¯¦ä½œå„ªå…ˆé †åº

### Phase 1: Module åŸºç¤æ¶æ§‹
```
- MODULE.yaml æ ¼å¼å®šç¾©
- ModuleRegistry è¼‰å…¥æ¨¡çµ„
- åŸºæœ¬ Orchestrator æ¡†æ¶
```

### Phase 2: Task Planner
```
- LLM é©…å‹•çš„ä»»å‹™è¦åŠƒ
- ä¾è³´é—œä¿‚è§£æ
- åŸ·è¡Œè¨ˆåŠƒç”¢ç”Ÿ
```

### Phase 3: State Machine
```
- ç‹€æ…‹è¿½è¹¤
- æ­¥é©ŸåŸ·è¡Œ
- éŒ¯èª¤è™•ç† + å›æ»¾
```

### Phase 4: Quality Validation
```
- å„é¡å‹ Validator
- å“è³ªè©•åˆ†
- æ”¹é€²å»ºè­°
```

### Phase 5: 3090 Compute æ•´åˆ
```
- æœ¬åœ° LLM ä½œç‚º Planner
- Embedding åšæ„åœ–åˆ†é¡
- æ¸›å°‘å°å¤–éƒ¨ API ä¾è³´
```

---

## 7. çµè«–

Module Orchestrator æ˜¯å¾ã€Œå–®æ¬¡ Skill åŒ¹é…ã€å‡ç´šåˆ°ã€Œå¤šæ­¥é©Ÿä»»å‹™ç·¨æ’ã€çš„é—œéµï¼š

1. **ç²¾æº–åº¦** - é€é Planner + Step Validation ç¢ºä¿æ¯ä¸€æ­¥éƒ½æ­£ç¢º
2. **ç²¾ç·»åº¦** - é€é Quality Criteria + Validators ç¢ºä¿ç”¢å‡ºå“è³ª
3. **å¯é æ€§** - é€é State Machine + Rollback è™•ç†å¤±æ•—æƒ…æ³
4. **å¯è¿½è¹¤** - é€éçµæ§‹åŒ–çš„ä»»å‹™åŸ·è¡Œè¨˜éŒ„

é€™æ˜¯è®“ AI Agent å¾ã€Œèƒ½ç”¨ã€è®Šæˆã€Œå¥½ç”¨ã€çš„é—œéµå‡ç´šã€‚
