---
title: SHC Proxy 端口配置問題分析
date: 2026-01-31
category: tech/devops
tags: [shc, proxy, port, configuration]
---

# SHC Proxy 端口配置問題分析

## 問題現象

測試時發現 SHC Proxy 的端口在 8080 和 8081 之間「飄來飄去」,導致混淆。

## 根本原因

### 1. 程式碼預設端口

**proxy.py** 的端口配置:

```python
port = int(os.environ.get('PORT', 8080))  # 預設 8080
app.run(host='0.0.0.0', port=port, debug=False, threaded=True)
```

- **預設**: 8080
- **可覆蓋**: 環境變數 `PORT`

### 2. 目前實際運行狀態

**acmacmini2 上的 SHC Proxy (PID 293143)**:

```bash
# 實際監聽端口
ss -tlnp | grep 293143
# 結果: LISTEN 0.0.0.0:8081

# 環境變數
cat /proc/293143/environ | tr '\0' '\n' | grep PORT
# 結果: PORT=8081
```

**實際使用**: **8081**

### 3. 環境變數來源

檢查過的位置:
- ❌ `.env` 檔案 - 沒有 PORT 設定
- ❌ `.bashrc/.profile` - 沒有 PORT export
- ❌ systemd service - 沒有對應 service
- ❌ crontab - 沒有自動啟動

**結論**: `PORT=8081` 是在**手動啟動時**設定的:

```bash
# 可能的啟動方式
PORT=8081 nohup python3 proxy.py > proxy.log 2>&1 &

# 或
export PORT=8081
nohup python3 proxy.py > proxy.log 2>&1 &
```

## 為什麼會混淆?

### 不同來源的設定不一致

1. **程式碼預設**: 8080
2. **實際運行**: 8081 (手動設定)
3. **測試配置** (`test_config.py`): 8081
4. **文件記錄**: 不明確

### 測試失敗的連鎖反應

因為 8081 只監聽 `0.0.0.0`,可以從 acmacmini2 本機訪問,但無法從外部 (ac-mac) 直接連接:

```bash
# ✅ 本機可用
ssh acmacmini2 "curl http://localhost:8081/health"

# ❌ 外部連接失敗 (timeout)
curl http://acmacmini2:8081/health
```

需要 SSH tunnel:

```bash
ssh -f -N -L 8081:localhost:8081 acmacmini2
# 然後從 ac-mac:
curl http://localhost:8081/health
```

## 解決方案

### 方案 1: 統一使用 8081 (建議)

**優點**: 與目前運行狀態一致,最小變動

**步驟**:

1. 在 `.env` 明確設定:
   ```bash
   echo "PORT=8081" >> ~/workshop/super-happy-coder/.env
   ```

2. 重啟服務確認:
   ```bash
   pkill -f "proxy.py"
   cd ~/workshop/super-happy-coder
   nohup python3 proxy.py > proxy.log 2>&1 &
   ```

3. 確保測試配置正確:
   - `test_config.py`: `BASE_URL = "http://localhost:8081"` ✅ (已正確)
   - 需要 SSH tunnel: `ssh -f -N -L 8081:localhost:8081 acmacmini2`

### 方案 2: 統一使用 8080

**優點**: 符合程式碼預設

**步驟**:

1. 移除環境變數 PORT (使用預設)
2. 更新 `test_config.py`: `BASE_URL = "http://localhost:8080"`
3. 建立 SSH tunnel: `ssh -f -N -L 8080:localhost:8080 acmacmini2`

### 方案 3: 允許外部連接 (不建議,安全風險)

修改防火牆允許外部訪問 8081,這樣就不需要 SSH tunnel。

**不建議**: 暴露服務到公網有安全風險。

## 推薦做法

### 立即行動

1. **明確記錄**: 在 `.env` 加入 `PORT=8081`
2. **建立 tunnel**: 測試前自動建立 SSH tunnel
3. **文件更新**: README 明確說明端口配置

### 長期改善

1. **容器化**: 使用 Docker,明確端口映射
2. **配置管理**: 使用 ansible/terraform 統一配置
3. **監控告警**: 端口變更時發出警告

## 自動化腳本

```bash
#!/bin/bash
# 確保 SHC Proxy tunnel 存在
if ! pgrep -f "ssh.*8081.*acmacmini2" > /dev/null; then
    echo "建立 SSH tunnel: localhost:8081 -> acmacmini2:8081"
    ssh -f -N -L 8081:localhost:8081 acmacmini2
fi

# 驗證連接
if curl -s http://localhost:8081/health > /dev/null; then
    echo "✅ SHC Proxy 可訪問"
else
    echo "❌ SHC Proxy 無法連接"
    exit 1
fi
```

## 總結

**端口飄移的原因**: 程式碼預設 8080,但手動啟動時設定 `PORT=8081`,導致實際運行在 8081。

**解決方式**: 在 `.env` 明確設定 `PORT=8081`,並確保測試時建立 SSH tunnel。
