---
title: ac-mac 系統死當分析（snapd watchdog timeout）
date: 2026-01-30
category: tech
tags: [ac-mac, crash, snapd, watchdog, 系統維護]
source: 本機日誌分析
---

# ac-mac 系統死當分析

## 摘要

2026-01-30 約 18:48，ac-mac 發生系統無回應（死當），無法透過 SSH、Tailscale、Telegram Bot 連線。系統未自動重啟，需手動重開機。根因為 **snapd 服務消耗過多 CPU（3 分 46 秒），觸發 watchdog timeout 被 SIGKILL**，連鎖導致系統資源耗盡。

## 關鍵要點

- snapd 是罪魁禍首，消耗 3m46s CPU 後被系統強制終止
- rtkit-daemon 偵測到線程飢餓（canary thread starvation），代表 CPU 資源已嚴重不足
- 連鎖反應：snapd 崩潰 → CPU 耗盡 → I/O 阻塞 → 資料庫逾時 → 網路失效 → 系統凍結
- 系統未自動重啟，約 20:59 手動重開機恢復

---

## 1. 時間線

| 時間 | 事件 |
|------|------|
| 18:48:04 | rtkit-daemon 首次報告 canary thread starvation |
| 18:48:25 | `snapd.service: State 'stop-watchdog' timed out. Killing.` |
| 18:48:25 | snapd 被 SIGKILL，記錄已消耗 **3min 46.559s CPU time** |
| 18:48:25 | snapd 嘗試自動重啟 |
| 18:48:29 | rtkit-daemon 第二次報告 thread starvation |
| 18:48:54 | rtkit-daemon 第三次報告 thread starvation |
| 18:51:16 | tg-claude-bot 最後一次成功的 getUpdates (HTTP 200) |
| 18:51:16+ | 系統逐漸無回應，僅剩 Tailscale 重連日誌 |
| ~20:57:55 | boot -1 最後一筆日誌（n8n workflow history compaction） |
| 20:59:02 | 手動重開機，新 boot 開始 |

---

## 2. 根因分析

### 2.1 直接原因：snapd watchdog timeout

```
1月 30 18:48:25 ac-mac systemd[1]: snapd.service: State 'stop-watchdog' timed out. Killing.
1月 30 18:48:25 ac-mac systemd[1]: snapd.service: Consumed 3min 46.559s CPU time.
```

snapd（Snap 套件管理服務）因不明原因消耗大量 CPU，超過 watchdog 設定的逾時時間，被 systemd 以 SIGKILL 強制終止。

### 2.2 連鎖反應

```
snapd CPU 暴衝 (3m46s)
  → CPU 資源耗盡
    → rtkit-daemon 偵測 thread starvation (3 次)
    → I/O 操作阻塞
      → n8n 資料庫連線逾時
      → DNS 解析失敗
      → Telegram Bot 連線中斷
      → SSH / Tailscale 無法回應
        → 系統完全凍結
```

### 2.3 系統資源飢餓證據

```
1月 30 18:48:04 ac-mac rtkit-daemon[804]: The canary thread is apparently starving. Taking action.
1月 30 18:48:29 ac-mac rtkit-daemon[804]: The canary thread is apparently starving. Taking action.
1月 30 18:48:54 ac-mac rtkit-daemon[804]: The canary thread is apparently starving. Taking action.
```

rtkit-daemon 的 canary thread 是用來偵測系統排程是否正常的機制。連續三次報告飢餓，代表 CPU 已經嚴重過載，無法正常排程線程。

---

## 3. Boot 紀錄

```
-1  ac-mac  2026-01-25 19:43:19 → 2026-01-30 20:57:55  (4天+)
 0  ac-mac  2026-01-30 20:59:02 → 至今
```

系統從 1/25 開機後連續運行約 5 天，於 1/30 18:48 開始出問題，20:59 手動重開機。

---

## 4. 受影響服務

| 服務 | 影響 |
|------|------|
| tg-claude-bot | 18:51 後停止回應 |
| tg-monitor-bot | 無法發送監控訊息 |
| n8n | 資料庫連線逾時 |
| SSH | 無法遠端連線 |
| Tailscale | 持續重連但無法恢復 |

---

## 5. 當前網路狀態

重開機後發現：
- `enp2s0f0`（有線網路）：NO-CARRIER / 網線未接或故障
- `wlp3s0b1`（WiFi）：UP，目前使用 WiFi 連線

---

## 6. 建議處理

### 6.1 短期（立即）
1. **檢查 snap 套件清單**：`snap list` 確認裝了哪些 snap
2. **考慮停用 snapd**：如果沒有必要的 snap 套件，可以停用
   ```bash
   sudo systemctl stop snapd
   sudo systemctl disable snapd
   sudo systemctl mask snapd
   ```
3. **檢查有線網路**：確認網線是否鬆脫或故障

### 6.2 中期
1. **設定自動重啟**：配置 kernel watchdog，系統凍結時自動重啟
   ```bash
   # /etc/sysctl.d/99-watchdog.conf
   kernel.watchdog_thresh = 30
   kernel.panic = 10       # kernel panic 後 10 秒自動重啟
   kernel.panic_on_oops = 1
   ```
2. **監控 snapd 資源使用**：如果保留 snapd，設定 cgroup 限制其 CPU 使用
3. **增加系統監控告警**：在 tg-monitor-bot 增加 CPU 使用率異常告警

### 6.3 長期
1. **評估是否完全移除 snapd**：Ubuntu Server 可以不依賴 snap
2. **定期檢查系統日誌**：`journalctl -p err -b` 看有無異常

---

## 7. 診斷指令備忘

```bash
# 查看 boot 紀錄
journalctl --list-boots

# 查看上次 boot 的日誌
journalctl -b -1

# 查看特定時間範圍的錯誤
journalctl -b -1 --since "2026-01-30 18:45" --until "2026-01-30 19:00" -p err

# 查看 snapd 狀態
systemctl status snapd
snap list

# 查看網路介面狀態
ip link show
```

---

**分析時間**: 2026-01-30 ~22:30 (UTC+8)
**分析執行者**: Claude Code (from ac-mac)
