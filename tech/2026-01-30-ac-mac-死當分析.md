---
title: ac-mac 系統死當分析（Tailscale ACL 變更引發）
date: 2026-01-30
category: tech
tags: [ac-mac, crash, tailscale, snapd, watchdog, 系統維護]
source: 本機日誌分析
---

# ac-mac 系統死當分析

## 摘要

2026-01-30 約 18:48，ac-mac 發生系統無回應（死當），無法透過 SSH、Tailscale、Telegram Bot 連線。系統未自動重啟，需手動重開機。**根因為 Tailscale ACL 設定變更（重設 ACL + 關閉 macmini2 SSH），導致 Tailscale 網路連線異常**，snapd 因網路相關操作卡住而 CPU 暴衝，最終觸發 watchdog timeout 連鎖凍結系統。

## 關鍵要點

- **根因是 Tailscale ACL 變更**，不是 snapd 本身——snapd 是受害者
- 約 18:48 修改 Tailscale ACL 並關閉 macmini2 SSH 功能，造成網路連線異常
- Tailscale 持續 3 分鐘以上瘋狂重連報錯，應在此階段就介入重啟 Tailscale
- snapd 可能因網路操作（snap store 連線等）被卡住，CPU 暴衝 3m46s 後被 SIGKILL
- 系統未自動重啟，約 20:59 手動重開機恢復
- **需要監控機制**：Tailscale 連線異常超過一定時間應自動重啟或告警

---

## 1. 時間線

| 時間 | 事件 |
|------|------|
| ~18:48 | **觸發點：修改 Tailscale ACL，關閉 macmini2 SSH 功能** |
| 18:48+ | Tailscale 偵測到 ACL 變更，開始持續重連（大量錯誤日誌） |
| 18:48:04 | rtkit-daemon 首次報告 canary thread starvation（CPU 已過載） |
| 18:48:25 | `snapd.service: State 'stop-watchdog' timed out. Killing.`（snapd 因網路異常卡住） |
| 18:48:25 | snapd 被 SIGKILL，記錄已消耗 **3min 46.559s CPU time** |
| 18:48:25 | snapd 嘗試自動重啟（但系統已不穩定） |
| 18:48:29 | rtkit-daemon 第二次報告 thread starvation |
| 18:48:54 | rtkit-daemon 第三次報告 thread starvation |
| 18:51:16 | tg-claude-bot 最後一次成功的 getUpdates (HTTP 200) |
| 18:51:16+ | 系統逐漸無回應，僅剩 Tailscale 重連日誌持續刷 |
| ~20:57:55 | boot -1 最後一筆日誌（n8n workflow history compaction） |
| 20:59:02 | 手動重開機，新 boot 開始 |

---

## 2. 根因分析

### 2.1 根因：Tailscale ACL 變更導致網路異常

約 18:48，操作者在 Tailscale 管理後台：
1. **重設了 ACL 規則**
2. **關閉了 macmini2 的 Tailscale SSH 功能**

這導致 ac-mac 的 Tailscale 客戶端偵測到 ACL 變更後，開始持續重新連線，產生大量錯誤日誌（持續 3 分鐘以上）。

### 2.2 連鎖反應

```
Tailscale ACL 變更（根因）
  → Tailscale 持續重連報錯（3+ 分鐘）
    → 網路連線不穩定
      → snapd 因 snap store / 網路操作卡住，CPU 暴衝 (3m46s)
        → systemd watchdog timeout → SIGKILL snapd
        → rtkit-daemon 偵測 thread starvation (3 次)
        → CPU 資源耗盡 → I/O 阻塞
          → n8n 資料庫連線逾時
          → DNS 解析失敗
          → Telegram Bot 連線中斷
          → SSH 無法回應
            → 系統完全凍結
```

**snapd 不是根因，而是受害者**——它因為網路異常而卡住，進而加劇了系統資源耗盡。

### 2.3 snapd watchdog timeout（次要原因）

```
1月 30 18:48:25 ac-mac systemd[1]: snapd.service: State 'stop-watchdog' timed out. Killing.
1月 30 18:48:25 ac-mac systemd[1]: snapd.service: Consumed 3min 46.559s CPU time.
```

snapd 在網路異常時嘗試重試操作，消耗大量 CPU，超過 watchdog 逾時被 SIGKILL。這進一步惡化了系統狀態。

### 2.4 系統資源飢餓證據

```
1月 30 18:48:04 ac-mac rtkit-daemon[804]: The canary thread is apparently starving. Taking action.
1月 30 18:48:29 ac-mac rtkit-daemon[804]: The canary thread is apparently starving. Taking action.
1月 30 18:48:54 ac-mac rtkit-daemon[804]: The canary thread is apparently starving. Taking action.
```

rtkit-daemon 的 canary thread 偵測到系統排程異常，連續三次報告飢餓，代表 CPU 已嚴重過載。

### 2.5 教訓：Tailscale 重連應及早介入

Tailscale 持續重連報錯超過 3 分鐘，這段時間如果有監控機制偵測到並自動重啟 `tailscaled`，可能就不會演變成系統凍結。

---

## 3. Boot 紀錄

```
-1  ac-mac  2026-01-25 19:43:19 → 2026-01-30 20:57:55  (4天+)
 0  ac-mac  2026-01-30 20:59:02 → 至今
```

系統從 1/25 開機後連續運行約 5 天，於 1/30 18:48 開始出問題，20:59 手動重開機。

---

## 4. 受影響服務

| 服務 | 影響 |
|------|------|
| tg-claude-bot | 18:51 後停止回應 |
| tg-monitor-bot | 無法發送監控訊息 |
| n8n | 資料庫連線逾時 |
| SSH | 無法遠端連線 |
| Tailscale | 持續重連但無法恢復 |

---

## 5. 當前網路狀態

重開機後發現：
- `enp2s0f0`（有線網路）：NO-CARRIER / 網線未接或故障
- `wlp3s0b1`（WiFi）：UP，目前使用 WiFi 連線

---

## 6. 已實施的改善措施

### 6.1 ✅ 網路健康監控（已完成，2026-01-30 23:27）

已整合到 `tg-monitor-bot` (`/usr/local/bin/server-monitor/tg-monitor-bot.py`)，以背景任務方式運行：

**監控邏輯：**
```
每 60 秒檢查
  ├─ Telegram API 通路（curl getMe）
  ├─ Tailscale 連線（tailscale status + tailscale ip）
  │
  ├─ 正常 → 靜默運行
  ├─ 異常 → fail_count++
  │   └─ 連續 3 次（3 分鐘）→ 自動重啟 tailscaled + 發 Telegram 告警
  │       └─ 重啟 3 次仍失敗 → 自動 reboot 系統
  └─ 從異常恢復 → 發恢復通知
```

**新增指令：** `/health` — 查看網路健康監控即時狀態

**相關設定：**
- sudoers: `/etc/sudoers.d/tailscale-monitor`（允許免密碼 `systemctl restart tailscaled` 和 `reboot`）
- Git commit: `ace5d5a`

### 6.2 待處理

| 項目 | 優先級 | 狀態 |
|------|--------|------|
| 其他設備心跳監控（混合制：方案 C） | 高 | ⬜ 待處理 |
| 檢查有線網路（enp2s0f0 NO-CARRIER） | 中 | ⬜ 待處理 |
| Tailscale ACL 變更 SOP | 中 | ⬜ 待處理 |
| kernel watchdog 自動重啟設定 | 中 | ⬜ 待處理 |
| 評估 snapd 套件遷移（移除或限制 CPU） | 低 | ⬜ 待處理 |

#### 其他設備心跳監控方案筆記

**採用方案：混合制（方案 C）** ✅

結合 ac-mac 主動輪巡 + 各機器自己監控自己的 Tailscale，達到最佳可靠性：

**1. ac-mac 主動輪巡（集中監控）**
- 在 `network_health_monitor` 迴圈中，每 5 分鐘 SSH ping 其他 3 台機器（3090、rpi5、macmini2）
- 連續 3 次不通則發 Telegram 告警
- 優點：集中管理、統一告警、不需改其他機器

**2. 各機器自我監控（分散式自救）**
- 每台機器部署輕量監控腳本，定期檢查自己的 Tailscale 連線
- 異常時自動重啟本機 tailscaled
- 優點：ac-mac 掛了其他機器還能自救

**實作計畫：**
- ac-mac：已完成本機健康監控（✅），待加入遠端輪巡
- 其他 3 台：複製 ac-mac 的 Tailscale 監控邏輯（簡化版，不含 Telegram API 檢查）

#### snapd 相關資訊

**已安裝 snap 套件：** VSCode (classic), Firefox, Snap Store, gnome-42-2204, gtk-common-themes

**snapd 是什麼：** Ubuntu 的 Snap 套件管理系統後台服務，負責安裝/更新 snap 應用

**為何可能有問題：**
- 1/30 死當時，snapd 因網路異常卡住，CPU 暴衝 3m46s 後被 SIGKILL
- snapd 會自動連線 Snap Store 檢查更新，網路異常時容易卡住

**處理選項：**
- 方案 1：移除 snapd，將 VSCode、Firefox 改用官方 deb 或 apt 安裝
- 方案 2：保留 snapd，設定 cgroup 限制 CPU 使用 + 網路 timeout
- 方案 3：保留但停用自動更新：`snap refresh --hold`

---

## 7. 診斷指令備忘

```bash
# 查看 boot 紀錄
journalctl --list-boots

# 查看上次 boot 的日誌
journalctl -b -1

# 查看特定時間範圍的錯誤
journalctl -b -1 --since "2026-01-30 18:45" --until "2026-01-30 19:00" -p err

# 查看 snapd 狀態
systemctl status snapd
snap list

# 查看網路介面狀態
ip link show

# 查看網路健康監控狀態（Telegram Bot）
# /health

# 查看監控日誌
sudo journalctl -u tg-monitor-bot --since "1 hour ago" | grep -E "網路|健康|tailscale"
```

---

**分析時間**: 2026-01-30 ~22:30 (UTC+8)
**更新時間**: 2026-01-30 ~23:30（新增已實施改善措施）
**分析執行者**: Claude Code (from ac-mac)
